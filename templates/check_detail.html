<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Detail - {{ check.check_number if check else 'Check Validation' }} - Check Validation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- PDF.js for fast PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* Responsive fluid container - expands elegantly with screen size */
        .container-fluid {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Smart max-widths for different screen sizes */
        @media (min-width: 1536px) {
            .container-fluid {
                max-width: 1800px; /* 2xl screens - generous width */
            }
        }
        
        @media (min-width: 1920px) {
            .container-fluid {
                max-width: 2000px; /* Full HD+ screens */
            }
        }
        
        @media (min-width: 2560px) {
            .container-fluid {
                max-width: 2400px; /* 2K/4K screens - use more space */
            }
        }
        
        /* Grid background pattern */
        .grid-background {
            background-image: 
                linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .grid-background-hidden {
            background-image: none;
        }

        /* Field status indicators */
        .field-status {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        /* Remove the field status icon styles */
        .field-container {
            position: relative;
        }

        .field-complete {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .field-incomplete {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }

        .field-error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        /* ===================================================================== */
        /* FIELD HIGHLIGHTS - Subtle & Professional */
        /* ===================================================================== */
        
        /* Green highlight for extracted data - clean and subtle */
        .field-extracted {
            background: linear-gradient(to right, #ecfdf5 0%, #f0fdf4 100%);
            border-color: #86efac;
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.1);
        }
        
        /* Blue highlight for Salesforce-pulled data - professional and distinct */
        .field-salesforce {
            background: linear-gradient(to right, #eff6ff 0%, #f0f9ff 100%);
            border-color: #93c5fd;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.1);
        }
        
        /* Focus states maintain the highlight colors */
        .field-extracted:focus {
            background: #f0fdf4;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        
        .field-salesforce:focus {
            background: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* ===================================================================== */
        /* SEARCHABLE DROPDOWN - Clean & Professional üîç */
        /* ===================================================================== */
        
        /* Hide the original select element */
        /* üî• MATTER NAME SELECT - Searchable Dropdown Styling */
        select.matter-name-select {
            display: none !important;
        }

        .dropdown-select {
            background-color: #fff;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
            cursor: pointer;
            display: block;
            font-size: 0.875rem;
            height: auto;
            line-height: 1.5rem;
            outline: none;
            padding: 0.5rem 0.75rem;
            padding-right: 2rem;
            position: relative;
            text-align: left !important;
            transition: all 0.2s ease-in-out;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            white-space: nowrap;
            width: 100%;
        }

        .dropdown-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dropdown-select:hover {
            border-color: #9ca3af;
        }

        .dropdown-select:active,
        .dropdown-select.open {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Dropdown arrow */
        .dropdown-select:after {
            height: 0;
            width: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #6b7280;
            -webkit-transform: origin(50% 20%);
            transform: origin(50% 20%);
            transition: all 0.125s ease-in-out;
            content: '';
            display: block;
            margin-top: -2px;
            pointer-events: none;
            position: absolute;
            right: 0.75rem;
            top: 50%;
        }

        .dropdown-select.open:after {
            -webkit-transform: rotate(-180deg);
            transform: rotate(-180deg);
        }

        .dropdown-select.open .list {
            -webkit-transform: scale(1);
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .dropdown-select.open .option {
            cursor: pointer;
        }

        /* Dropdown list container */
        .dropdown-select .list {
            box-sizing: border-box;
            transition: all 0.15s cubic-bezier(0.25, 0, 0.25, 1.75), opacity 0.1s linear;
            -webkit-transform: scale(0.75);
            transform: scale(0.75);
            -webkit-transform-origin: 0% 0;
            transform-origin: 0% 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-color: #fff;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            padding: 0;
            opacity: 0;
            overflow-x: visible;
            overflow-y: auto;
            pointer-events: none;
            position: fixed;
            top: auto;
            left: auto;
            transform: scale(0.75);
            transform-origin: top right;
            right: auto;
            width: 500px;
            max-width: 90vw;
            z-index: 9999; /* ABOVE backdrop */
            max-height: 70vh;
            border: 2px solid #3b82f6;
        }

        .dropdown-select .list:hover .option:not(:hover) {
            background-color: transparent !important;
        }

        /* üî• STICKY SEARCH BOX - Matches table width */
        .dropdown-select .dd-search {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 101;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-height: 60px;
            isolation: isolate;
        }

        .dropdown-select .dd-searchbox {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 0;
            outline: none;
            font-size: 0.875rem;
            transition: none;
            background: white;
            box-sizing: border-box;
        }

        .dropdown-select .dd-searchbox:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Dropdown options */
        .dropdown-select .list ul {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        /* üî• TABLE VIEW for search results */
        .dropdown-select .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .dropdown-select .results-table thead {
            position: sticky;
            top: 60px; /* Position below search box (12px padding + 36px input height + 12px padding) */
            z-index: 100;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .dropdown-select .results-table th {
            padding: 10px 12px;
            text-align: left;
            font-size: 10px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: #f9fafb;
            position: relative;
        }

        .dropdown-select .results-table tbody tr {
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .dropdown-select .results-table tbody tr:hover {
            background: linear-gradient(90deg, #eff6ff 0%, #f9fafb 100%);
        }

        .dropdown-select .results-table tbody tr.selected {
            background: linear-gradient(90deg, #dbeafe 0%, #eff6ff 100%);
        }

        .dropdown-select .results-table td {
            padding: 12px 12px;
            font-size: 12px;
            color: #374151;
            line-height: 1.5;
            vertical-align: top;
        }

        .dropdown-select .results-table td:first-child {
            font-weight: 500;
            color: #1f2937;
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 20px !important;
        }

        .dropdown-select .results-table td.text-gray {
            color: #6b7280;
        }

        /* Legacy card style for no-results and loading states */
        .dropdown-select .option {
            cursor: pointer;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.15s ease;
            list-style: none;
        }

        .dropdown-select .option:hover,
        .dropdown-select .option:focus {
            background-color: #f9fafb !important;
            border-left: 3px solid #3b82f6;
        }

        .dropdown-select .option.selected {
            background-color: #eff6ff;
            border-left: 3px solid #3b82f6;
        }

        .dropdown-select .option.selected:focus {
            background: #e0f2fe;
        }

        /* Card header with matter name and case type badge */
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .option-main {
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
        }

        .option-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Card details row */
        .option-details {
            display: flex;
            gap: 20px;
            color: #6b7280;
            font-size: 13px;
            flex-wrap: wrap;
        }

        .option-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .option-detail strong {
            color: #374151;
        }

        /* Empty state and prompt messages */
        .dropdown-select .option.no-results {
            color: #9ca3af;
            font-style: italic;
            cursor: default;
            transition: none !important;
        }

        .dropdown-select .option.no-results:hover,
        .dropdown-select .option.no-results:focus {
            background-color: transparent !important;
            border-left: 0 !important;
            border: none !important;
        }

        .dropdown-select .option.prompt-message {
            transition: none !important;
            pointer-events: none;
        }

        .dropdown-select .option.prompt-message:hover,
        .dropdown-select .option.prompt-message:focus {
            background-color: transparent !important;
            border-left: 0 !important;
            border: none !important;
        }

        /* üî• BACKDROP OVERLAY - Dims entire screen with smooth transitions */
        .dropdown-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9990;
            opacity: 0;
            /* Smooth fade in/out for opacity, delay visibility change until after fade-out */
            transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s;
            pointer-events: none;
            visibility: hidden;
        }

        .dropdown-backdrop.show {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
            /* When showing, make visibility instant (no delay) but keep opacity smooth */
            transition: opacity 0.3s ease-in-out, visibility 0s linear 0s;
        }

        /* üî• LEFT PANEL (PDF Viewer) - Stays bright above backdrop */
        .left-panel-bright {
            position: relative;
            z-index: 9995 !important;
        }

        /* üî• DRAGGABLE DIVIDER - Simple and intuitive */
        .panel-divider {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            background: transparent;
            cursor: col-resize;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Simple vertical grip bar */
        .panel-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 48px;
            background: #d1d5db;
            border-radius: 3px;
            transition: all 0.15s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Three horizontal lines for grip texture */
        .panel-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 5px;
            height: 20px;
            background-image:
                linear-gradient(#9ca3af, #9ca3af),
                linear-gradient(#9ca3af, #9ca3af),
                linear-gradient(#9ca3af, #9ca3af);
            background-size: 5px 1px;
            background-position: center 2px, center 10px, center 18px;
            background-repeat: no-repeat;
            transition: all 0.15s ease;
            pointer-events: none;
        }

        .panel-divider:hover::before {
            background: #3b82f6;
            height: 56px;
        }

        .panel-divider:hover::after {
            background-image:
                linear-gradient(white, white),
                linear-gradient(white, white),
                linear-gradient(white, white);
        }

        .panel-divider.dragging::before {
            background: #2563eb;
            height: 56px;
        }

        .panel-divider.dragging::after {
            background-image:
                linear-gradient(white, white),
                linear-gradient(white, white),
                linear-gradient(white, white);
        }

        /* ===================================================================== */
        /* üî• CHECK TYPE TOGGLE BUTTONS - Insurance vs Provider Selection */
        /* ===================================================================== */
        
        /* Icon-only button - matches the page's minimal aesthetic */
        .check-type-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 0;
            background: white;
            border: 1.5px solid #cbd5e1;
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .check-type-btn:hover {
            background: #f8fafc;
            border-color: #94a3b8;
            color: #475569;
            transform: scale(1.08);
        }

        /* Active state - subtle green glow matching approval button */
        .check-type-btn.active {
            background: #10b981;
            border-color: #10b981;
            color: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .check-type-btn.active:hover {
            background: #059669;
            border-color: #059669;
            transform: scale(1.08);
        }

        /* Undo button - minimal design */
        .check-type-undo-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 0;
            background: white;
            border: 1.5px solid #e5e7eb;
            border-radius: 6px;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .check-type-undo-btn:hover {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
            transform: rotate(-15deg) scale(1.08);
        }

        .check-type-undo-btn.hidden {
            display: none;
        }

        /* Disabled state for boxes - more subtle overlay */
        .box-disabled {
            opacity: 0.35;
            pointer-events: none;
            background: #f9fafb !important;
            position: relative;
        }

        .box-disabled::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(71, 85, 105, 0.08);
            border: 2px solid rgba(71, 85, 105, 0.15);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
        }

        .box-disabled::before {
            content: '‚úï';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #94a3b8;
            font-size: 32px;
            font-weight: 300;
            pointer-events: none;
            z-index: 11;
            opacity: 0.6;
        }

        /* ===================================================================== */
        /* L-SHAPED CORNER MARKERS - Precisely Aligned to Document Edges */
        /* ===================================================================== */
        
        .image-with-corners {
            position: relative;
            display: inline-block;
        }
        
        .corner-marker {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }
        
        /* L-shaped corner using CSS borders - Top Left */
        /* Positioned with 15px offset to float around the document */
        .corner-top-left {
            top: -20px;
            left: -20px;
            width: 16px;
            height: 16px;
            border-left: 5px solid rgba(0, 0, 0, 0.9);
            border-top: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* L-shaped corner - Top Right */
        .corner-top-right {
            top: -20px;
            right: -20px;
            width: 16px;
            height: 16px;
            border-right: 5px solid rgba(0, 0, 0, 0.9);
            border-top: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* L-shaped corner - Bottom Left */
        .corner-bottom-left {
            bottom: -20px;
            left: -20px;
            width: 16px;
            height: 16px;
            border-left: 5px solid rgba(0, 0, 0, 0.9);
            border-bottom: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* L-shaped corner - Bottom Right */
        .corner-bottom-right {
            bottom: -20px;
            right: -20px;
            width: 16px;
            height: 16px;
            border-right: 5px solid rgba(0, 0, 0, 0.9);
            border-bottom: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* Subtle animation for professional feel */
        @keyframes cornerPulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        .corner-marker:hover {
            animation: cornerPulse 1s ease-in-out;
        }
        
        /* Completely hide corners when grid is off */
        .corners-hidden .corner-marker {
            display: none;
        }
        
        /* Fade corners to light grey when dragging in grid mode */
        .corners-faded .corner-marker {
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }
        
        /* ===================================================================== */
        /* COMPACT RIGHT PANEL - Reduce vertical spacing for tighter layout */
        /* ===================================================================== */
        #rightPanel input[type="text"],
        #rightPanel input[type="email"],
        #rightPanel input[type="number"],
        #rightPanel textarea,
        #rightPanel select {
            padding: 0.375rem 0.75rem !important; /* py-1.5 px-3 - reduced from py-2 */
        }
        
        #rightPanel label {
            margin-bottom: 0.25rem !important; /* mb-1 - slightly reduced */
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="surface-elevated sticky top-0 z-50 backdrop-blur-md bg-white/95">
        <div class="container-fluid px-6 lg:px-8 xl:px-12 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-slate-800 to-slate-700 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-file-invoice-dollar fa-lg text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-primary">Check {{ check.check_number }}</h1>
                        <p class="text-xs text-tertiary font-medium">DETAILED VALIDATION</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    {% if user %}
                    <div class="flex items-center gap-4 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <div class="text-right">
                            <div class="text-sm font-medium text-slate-800">{{ user.name }}</div>
                            <div class="text-xs text-slate-600">{{ user.preferred_username }}</div>
                        </div>
                        <div class="w-8 h-8 bg-slate-600 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-user w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid px-6 lg:px-8 xl:px-12 py-8">
        <div class="surface rounded-xl mb-8 overflow-hidden">
            <!-- Header with Confidence Score -->
            <div class="px-6 py-3 bg-gradient-to-br from-slate-800 to-slate-700 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-base font-semibold text-white">Check Validation Workspace</h2>
                        <p class="text-xs text-white/80">Review image and extracted data side-by-side</p>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm text-white/70">Confidence Score:</span>
                                <span class="text-lg font-bold 
                                    {% if check.confidence_score >= 0.8 %}text-green-400
                                    {% elif check.confidence_score >= 0.6 %}text-yellow-400
                                    {% else %}text-red-400{% endif %}">
                                    {{ check.confidence_percentage }}%
                                </span>
                            </div>
                            <div class="text-xs 
                                {% if check.confidence_score >= 0.8 %}text-green-300
                                {% elif check.confidence_score >= 0.6 %}text-yellow-300
                                {% else %}text-red-300{% endif %}">
                                {% if check.confidence_score >= 0.8 %}
                                    Ready for quick approval
                                {% elif check.confidence_score >= 0.6 %}
                                    Review recommended
                                {% else %}
                                    Manual verification required
                                {% endif %}
                            </div>
                        </div>
                        
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                            {% if check.status == 'pending' %}bg-yellow-100 text-yellow-800
                            {% elif check.status == 'approved' %}bg-green-100 text-green-800
                            {% elif check.status == 'needs_review' %}bg-orange-100 text-orange-800
                            {% elif check.status == 'rejected' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ check.status | replace('_', ' ') | title }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Action Controls Bar -->
            <div class="px-6 py-3 bg-slate-700 border-t border-slate-600">
                <div class="flex items-center justify-between">
                    <!-- Left Side - Navigation & Image Controls -->
                    <div class="flex items-center gap-3">
                        <!-- Back to Batch Button -->
                        <a href="/checks/queue?batch={{ check.batch_id }}" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 border border-slate-500">
                            <i class="fa-solid fa-arrow-left w-3 h-3"></i>
                            Back to Batch
                        </a>
                        
                        <!-- Divider -->
                        <div class="h-8 w-px bg-slate-500"></div>
                        
                        <!-- Image Controls -->
                        <button id="zoomOut" class="btn-secondary px-3 py-1 text-xs">
                            <i class="fa-solid fa-minus w-3 h-3"></i>
                        </button>
                        <button id="zoomIn" class="btn-secondary px-3 py-1 text-xs">
                            <i class="fa-solid fa-plus w-3 h-3"></i>
                        </button>
                        <button id="resetZoom" class="btn-secondary px-3 py-1 text-xs">
                            <i class="fa-solid fa-expand w-3 h-3 mr-1"></i>
                            Fit
                        </button>
                        <button id="toggleGrid" class="btn-secondary px-3 py-1 text-xs bg-blue-100 text-blue-700">
                            <i class="fa-solid fa-border-all w-3 h-3 mr-1"></i>
                            Grid
                        </button>
                    </div>
                    
                    <!-- Right Side - Validation Actions -->
                    <div class="flex items-center gap-3" style="overflow: visible;">
                        <button id="quickApprove" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-check w-4 h-4"></i>
                            Quick Approve
                        </button>
                        <button id="undoApproval" class="hidden bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-rotate-left w-4 h-4"></i>
                            Undo Approval
                        </button>
                        <button id="sendToReview" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass w-4 h-4"></i>
                            Needs Review
                        </button>

                        <!-- Three Dot Menu -->
                        <div class="relative inline-block" id="moreActionsMenu" style="z-index: 10;">
                            <button type="button" id="moreActionsBtn" onclick="toggleMoreActionsMenu(event)" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors" style="cursor: pointer; pointer-events: auto;">
                                <i class="fa-solid fa-ellipsis-vertical w-4 h-4"></i>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="moreActionsDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200" style="z-index: 9999;">
                                <div class="py-1">
                                    <button type="button" id="deleteCheck" onclick="deleteCheckHandler()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors">
                                        <i class="fa-solid fa-trash w-4 h-4"></i>
                                        Delete Check
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- DISABLED: Save Progress button - needs fixing before re-enabling -->
                        <!-- <button id="saveProgress" class="bg-slate-500 hover:bg-slate-400 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-save w-4 h-4"></i>
                            Save Progress
                        </button> -->
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area - Image Left, Fields Right -->
            <div id="mainPanelsContainer" class="flex flex-col lg:flex-row min-h-[700px] xl:min-h-[800px] 2xl:min-h-[900px]" style="border-top-right-radius: 12px; overflow: hidden; position: relative;">
                <!-- Left Side - Check Image -->
                <div id="leftPanel" class="lg:w-[35%] xl:w-[38%] 2xl:w-[40%] bg-gray-50 border-r border-gray-200 flex flex-col">
                    <!-- Image Container -->
                    <div class="flex-1 relative">
                        {% if check.image_data or check.batch_images %}     
                            <!-- Batch Navigation Bar (if multiple images) -->
                            {% if check.batch_images and check.batch_images|length > 1 %}
                            <div class="bg-gray-100 border-b border-gray-200 px-4 py-2">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-600">
                                        <span id="currentImageIndex">1</span> of {{ check.batch_images|length }} images
                                        {% if check.batch_id %}
                                        <span class="ml-2 text-xs text-gray-500">(Batch: {{ check.batch_id }})</span>
                                        {% endif %} 
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="prevImage" class="px-2 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i class="fa-solid fa-chevron-left w-3 h-3"></i>
                                        </button>
                                        <button id="nextImage" class="px-2 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i class="fa-solid fa-chevron-right w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div id="imageContainer" class="h-full overflow-auto bg-gray-50 grid-background-hidden" style="cursor: grab;">
                                <div id="imageWrapper" class="p-4 h-full flex items-center justify-center relative">
                                    <div class="image-with-corners">
                                        <!-- PDF Canvas - Renders PDFs with vector quality -->
                                        <canvas id="pdfCanvas"
                                            class="border shadow-lg bg-white"
                                            style="transition: transform 0.1s ease-out;"
                                            data-check-id="{{ check.id }}"
                                            data-current-index="0">
                                        </canvas>
                                        
                                        <!-- Loading indicator -->
                                        <div id="pdfLoading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90">
                                            <div class="text-center">
                                                <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600 mb-2"></i>
                                                <p class="text-sm text-gray-600">Loading PDF...</p>
                                            </div>
                                        </div>
                                        
                                        <!-- L-shaped Corner Markers - Follow Image Transform -->
                                        <div class="corner-marker corner-top-left"></div>
                                        <div class="corner-marker corner-top-right"></div>
                                        <div class="corner-marker corner-bottom-left"></div>
                                        <div class="corner-marker corner-bottom-right"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden error fallback -->
                            <div id="imageError" style="display: none;" class="h-full bg-red-50 border-2 border-dashed border-red-300 flex items-center justify-center">
                                <div class="text-center">
                                    <i class="fa-solid fa-exclamation-triangle w-16 h-16 text-red-400 mb-4"></i>
                                    <h3 class="text-lg font-medium text-red-600 mb-2">PDF Load Error</h3>
                                    <p class="text-sm text-red-500">Unable to display check PDF</p>
                                </div>
                            </div>
                        {% else %}
                            <!-- Placeholder when no image available -->
                            <div class="h-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center">
                                <div class="text-center">
                                    <i class="fa-solid fa-image w-16 h-16 text-gray-400 mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-600 mb-2">No Image Available</h3>
                                    <p class="text-sm text-gray-500">
                                        {% if check.file_name %}
                                            File: {{ check.file_name }}
                                        {% else %}
                                            No image data found
                                        {% endif %}
                                    </p>
                                    {% if check.file_id %}
                                    <p class="text-xs text-gray-400 mt-1">File ID: {{ check.file_id }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Image Info Bar -->
                    <div class="px-4 py-2 bg-gray-100 border-t border-gray-200 flex items-center justify-between text-xs text-gray-600">
                        <div class="flex items-center gap-4">
                            {% if check.file_name %}
                            <span><i class="fa-solid fa-file mr-1"></i>{{ check.file_name }}</span>
                            {% endif %}
                            <!-- <span id="imageDimensions"><i class="fa-solid fa-ruler-combined mr-1"></i></span> -->
                        </div>
                        <div class="flex items-center gap-4">
                            <span><i class="fa-solid fa-mouse-pointer mr-1"></i>Drag to pan</span>
                            <span id="zoomLevel">80%</span>
                        </div>
                    </div>
                </div>

                <!-- üî• DRAGGABLE DIVIDER -->
                <div id="panelDivider" class="panel-divider hidden lg:block"></div>

                <!-- Right Side - Check Details Form -->
                <div id="rightPanel" class="lg:w-[65%] xl:w-[62%] 2xl:w-[60%] bg-white border-l-2 border-gray-300">
                    <div class="p-6 xl:p-8 h-full overflow-y-auto">
                        <form id="checkDetailsForm">
                            <!-- Hidden field for insurance_id -->
                            <input type="hidden" name="insurance_id" value="{{ check.insurance_id or '' }}">
                            
                            <!-- üî• Hidden field to store check type selection (insurance vs provider) -->
                            <input type="hidden" id="checkTypeSelection" name="check_type_selection" value="">

                            <!-- Extracted Fields Grid -->
                            <div class="space-y-2">
                                <!-- Case Information - MOVED TO TOP -->
                                <div class="space-y-2 bg-slate-50 border-2 border-slate-300 p-2.5 rounded-lg">
                                    <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide border-b-2 border-slate-400 pb-1.5">
                                        <i class="fa-solid fa-briefcase mr-2 text-slate-700"></i>Case Information
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 gap-2">
                                        <!-- üî• MATTER NAME - NOW THE SEARCHABLE DROPDOWN! -->
                                        <div class="field-container">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                                Matter Name 
                                                <span class="text-blue-600">
                                                    (Searchable) <i class="fa-solid fa-magnifying-glass"></i>
                                                </span>
                                            </label>
                                            <select name="matter_name" data-required="true" class="matter-name-select w-full">
                                                <option value="{{ check.matter_name }}" selected>{{ check.matter_name if check.matter_name else 'Search by matter name...' }}</option>
                                            </select>
                                            <div class="field-status">
                                                <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Matter ID</label>
                                                <input type="text" value="{{ check.matter_id or '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="matter_id" placeholder="Auto-populated from Salesforce" readonly>
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <!-- üî• CLAIMANT - NOW A REGULAR INPUT (auto-populated) -->
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Claimant</label>
                                                <input type="text" value="{{ check.claimant or '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="claimant" data-required="true" placeholder="Auto-populated from Matter" readonly>
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- üî• TWO-COLUMN LAYOUT: Provider & Claims + Salesforce Insurance -->
                                <div class="grid grid-cols-2 gap-2">
                                    <!-- LEFT: Provider & Claims Information -->
                                    <div id="providerClaimsBox" class="space-y-2 bg-slate-50 border-2 border-gray-300 p-2.5 rounded-lg transition-all duration-300">
                                        <div class="flex items-center justify-between border-b-2 border-gray-300 pb-1.5">
                                            <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">
                                                <i class="fa-solid fa-shield-halved mr-2 text-gray-700"></i>Extracted Provider & Claims
                                            </h3>
                                            <div class="flex items-center gap-1.5">
                                                <button type="button" id="useProviderBtn" class="check-type-btn" title="Mark as Provider/Third Party Check">
                                                    <i class="fa-solid fa-check"></i>
                                                </button>
                                                <button type="button" id="undoProviderBtn" class="check-type-undo-btn hidden" title="Clear selection">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 gap-2">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Provider Name</label>
                                                <input type="text" value="{{ check.provider_name if check.provider_name and check.provider_name != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="provider_name" placeholder="Provider name" data-required="true">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Claim Number</label>
                                                <input type="text" value="{{ check.claim_number if check.claim_number and check.claim_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="claim_number" placeholder="Claim number">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Policy Number</label>
                                                <input type="text" value="{{ check.policy_number if check.policy_number and check.policy_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="policy_number" placeholder="Policy number">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- RIGHT: Salesforce Insurance Data -->
                                    <div id="salesforceInsuranceBox" class="space-y-2 bg-slate-50 border-2 border-gray-300 p-2.5 rounded-lg transition-all duration-300">
                                        <div class="flex items-center justify-between border-b-2 border-gray-300 pb-1.5">
                                            <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">
                                                <i class="fa-solid fa-building-columns mr-2 text-gray-700"></i>Salesforce Insurance
                                            </h3>
                                            <div class="flex items-center gap-1.5">
                                                <button type="button" id="useInsuranceBtn" class="check-type-btn" title="Mark as Insurance Check">
                                                    <i class="fa-solid fa-check"></i>
                                                </button>
                                                <button type="button" id="undoInsuranceBtn" class="check-type-undo-btn hidden" title="Clear selection">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 gap-2">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Insurance Company</label>
                                                <input type="text" value="{{ check.insurance_company if check.insurance_company and check.insurance_company != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white"
                                                       name="insurance_company" placeholder="Auto-populated from Salesforce" readonly>
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">SF Claim Number</label>
                                                <input type="text" value="" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono bg-white"
                                                       name="sf_claim_number" placeholder="Auto-populated from Salesforce" readonly>
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">SF Policy Number</label>
                                                <input type="text" value="" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono bg-white"
                                                       name="sf_policy_number" placeholder="Auto-populated from Salesforce" readonly>
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Amount & Date -->
                                <div class="space-y-2 bg-slate-50 border-2 border-gray-300 p-2.5 rounded-lg">
                                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide border-b-2 border-gray-300 pb-1.5">
                                        <i class="fa-solid fa-dollar-sign mr-2 text-gray-700"></i>Amount & Date
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Amount</label>
                                                <input type="text" id="amountField"
                                                       value="${{ "{:,.2f}".format(check.amount | float) if check.amount else "0.00" }}" 
                                                       class="w-full px-3 py-2 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-bold text-green-700"
                                                       name="amount" data-required="true" placeholder="$0.00">  
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Check Type</label>
                                                <input type="text" 
                                                       value="{{ check.check_type or '' }}"
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="check_type">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Check Issue Date</label>
                                                <input type="text" 
                                                       value="{{ check.check_issue_date or '' }}"
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="check_issue_date" data-required="true">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Date of Loss</label>
                                                <input type="text" 
                                                       value="{{ check.date_of_loss or '' }}"
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="date_of_loss" placeholder="Date of loss">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="field-container">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Check Number</label>
                                            <input type="text" value="{{ check.check_number if check.check_number and check.check_number != 'None' else '' }}" 
                                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                   name="check_number" placeholder="Check number" data-required="true">
                                            <div class="field-status">
                                                <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Banking & Additional Information -->
                                <div class="space-y-2 bg-slate-50 border-2 border-gray-300 p-2.5 rounded-lg">
                                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide border-b-2 border-gray-300 pb-1.5">
                                        <i class="fa-solid fa-university mr-2 text-gray-700"></i>Banking & Additional Information
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Routing Number</label>
                                                <input type="text" value="{{ check.routing_number if check.routing_number and check.routing_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="routing_number" placeholder="Routing number" data-required="true">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Account Number</label>
                                                <input type="text" value="{{ check.account_number if check.account_number and check.account_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="account_number" placeholder="Account number" data-required="true">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="field-container">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Memo</label>
                                            <textarea 
                                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                                                   name="memo" rows="2" placeholder="Memo from check">{{ check.memo if check.memo and check.memo != 'None' else '' }}</textarea>
                                            <div class="field-status">
                                                <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                                    <i class="fa-solid fa-truck mr-1"></i>Delivery Service
                                                </label>
                                                <input type="text" value="{{ check.delivery_service if check.delivery_service and check.delivery_service != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="delivery_service" placeholder="e.g., FedEx, UPS, USPS">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                                    <i class="fa-solid fa-barcode mr-1"></i>Tracking Number
                                                </label>
                                                <input type="text" value="{{ check.tracking_number if check.tracking_number and check.tracking_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="tracking_number" placeholder="Tracking number">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ============================================================================
            // üî• DRAGGABLE PANEL DIVIDER - Resize left/right panels
            // ============================================================================

            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const divider = document.getElementById('panelDivider');
            const container = document.getElementById('mainPanelsContainer');

            let isPanelDragging = false;
            let panelStartX = 0;
            let panelStartLeftWidth = 0;
            let justFinishedDragging = false; // Track if we just finished dragging

            if (divider && leftPanel && rightPanel && container) {
                // Position divider initially at the border between panels
                function updateDividerPosition() {
                    if (window.innerWidth >= 1024) { // lg breakpoint
                        const leftRect = leftPanel.getBoundingClientRect();
                        divider.style.left = (leftRect.right - container.getBoundingClientRect().left - 4) + 'px';
                    }
                }

                // Update divider position on load and resize
                updateDividerPosition();
                window.addEventListener('resize', updateDividerPosition);

                // Start dragging
                divider.addEventListener('mousedown', function(e) {
                    if (window.innerWidth < 1024) return; // Only work on desktop

                    isPanelDragging = true;
                    panelStartX = e.clientX;
                    panelStartLeftWidth = leftPanel.offsetWidth;

                    divider.classList.add('dragging');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';

                    e.preventDefault();
                });

                // Handle dragging
                document.addEventListener('mousemove', function(e) {
                    if (!isPanelDragging) return;

                    const containerWidth = container.offsetWidth;
                    const deltaX = e.clientX - panelStartX;
                    const newLeftWidth = panelStartLeftWidth + deltaX;

                    // Set min/max constraints (30% to 70%)
                    const minWidth = containerWidth * 0.3;
                    const maxWidth = containerWidth * 0.7;

                    if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                        const leftPercentage = (newLeftWidth / containerWidth) * 100;
                        const rightPercentage = 100 - leftPercentage;

                        leftPanel.style.width = leftPercentage + '%';
                        rightPanel.style.width = rightPercentage + '%';

                        updateDividerPosition();

                        // üî• Trigger dropdown reposition if it's open
                        const dropdown = document.querySelector('.dropdown-select');
                        if (dropdown && dropdown.classList.contains('open')) {
                            // Dispatch a custom event to trigger reposition
                            window.dispatchEvent(new Event('panelResize'));
                        }
                    }

                    e.preventDefault();
                });

                // Stop dragging
                document.addEventListener('mouseup', function() {
                    if (isPanelDragging) {
                        isPanelDragging = false;
                        divider.classList.remove('dragging');
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';

                        // üî• Mark that we just finished dragging to prevent accidental dropdown close
                        justFinishedDragging = true;

                        // Clear the flag after a short delay (longer than click event timing)
                        setTimeout(() => {
                            justFinishedDragging = false;
                        }, 100);
                    }
                });
            }

            // Batch Images Setup
            const batchImages = {{ check.batch_images|tojson if check.batch_images else '[]' }};
            let currentImageIndex = 0;
            
            // ============================================================================
            // üî• CHECK TYPE TOGGLE SYSTEM - Insurance vs Provider Selection
            // ============================================================================
            
            const providerBox = document.getElementById('providerClaimsBox');
            const insuranceBox = document.getElementById('salesforceInsuranceBox');
            const useProviderBtn = document.getElementById('useProviderBtn');
            const useInsuranceBtn = document.getElementById('useInsuranceBtn');
            const undoProviderBtn = document.getElementById('undoProviderBtn');
            const undoInsuranceBtn = document.getElementById('undoInsuranceBtn');
            const checkTypeInput = document.getElementById('checkTypeSelection');
            
            // Function to enable Provider & disable Insurance
            function selectProvider() {
                console.log('üî• CHECK TYPE: Provider & Claims selected');
                
                // Activate Provider button
                useProviderBtn.classList.add('active');
                undoProviderBtn.classList.remove('hidden');
                
                // Deactivate Insurance button
                useInsuranceBtn.classList.remove('active');
                undoInsuranceBtn.classList.add('hidden');
                
                // Grey out Insurance box
                insuranceBox.classList.add('box-disabled');
                providerBox.classList.remove('box-disabled');
                
                // Disable Insurance fields
                const insuranceFields = insuranceBox.querySelectorAll('input');
                insuranceFields.forEach(field => {
                    field.disabled = true;
                    field.classList.add('bg-gray-100', 'cursor-not-allowed');
                });
                
                // Enable Provider fields
                const providerFields = providerBox.querySelectorAll('input');
                providerFields.forEach(field => {
                    field.disabled = false;
                    field.classList.remove('bg-gray-100', 'cursor-not-allowed');
                });
                
                // Store selection in hidden field
                checkTypeInput.value = 'provider';
            }
            
            // Function to enable Insurance & disable Provider
            function selectInsurance() {
                console.log('üî• CHECK TYPE: Salesforce Insurance selected');
                
                // Activate Insurance button
                useInsuranceBtn.classList.add('active');
                undoInsuranceBtn.classList.remove('hidden');
                
                // Deactivate Provider button
                useProviderBtn.classList.remove('active');
                undoProviderBtn.classList.add('hidden');
                
                // Grey out Provider box
                providerBox.classList.add('box-disabled');
                insuranceBox.classList.remove('box-disabled');
                
                // Disable Provider fields
                const providerFields = providerBox.querySelectorAll('input');
                providerFields.forEach(field => {
                    field.disabled = true;
                    field.classList.add('bg-gray-100', 'cursor-not-allowed');
                });
                
                // Enable Insurance fields
                const insuranceFields = insuranceBox.querySelectorAll('input');
                insuranceFields.forEach(field => {
                    field.disabled = false;
                    field.classList.remove('bg-gray-100', 'cursor-not-allowed');
                });
                
                // Store selection in hidden field
                checkTypeInput.value = 'insurance';
            }
            
            // Function to clear selection (undo)
            function clearSelection() {
                console.log('üîÑ CHECK TYPE: Selection cleared');
                
                // Deactivate both buttons
                useProviderBtn.classList.remove('active');
                useInsuranceBtn.classList.remove('active');
                undoProviderBtn.classList.add('hidden');
                undoInsuranceBtn.classList.add('hidden');
                
                // Remove disabled state from both boxes
                providerBox.classList.remove('box-disabled');
                insuranceBox.classList.remove('box-disabled');
                
                // Enable all fields
                const allFields = document.querySelectorAll('#providerClaimsBox input, #salesforceInsuranceBox input');
                allFields.forEach(field => {
                    field.disabled = false;
                    field.classList.remove('bg-gray-100', 'cursor-not-allowed');
                });
                
                // Clear hidden field
                checkTypeInput.value = '';
            }
            
            // Event listeners
            useProviderBtn.addEventListener('click', selectProvider);
            useInsuranceBtn.addEventListener('click', selectInsurance);
            undoProviderBtn.addEventListener('click', clearSelection);
            undoInsuranceBtn.addEventListener('click', clearSelection);
            
            console.log('‚úÖ Check type toggle system initialized');
            
            // ============================================================================
            // SEARCHABLE DROPDOWN SYSTEM - FIRE! üî•üîç
            // ============================================================================
            
            // Global variables for dropdown state
            let allClaimants = [];
            let claimantDropdownCreated = false;
            
            // üî• CREATE THE MATTER NAME DROPDOWN IMMEDIATELY!
            createCustomDropdown();
            
            // ============================================================================
            // SALESFORCE SEARCH - Real-time as you type! üî•
            // ============================================================================
            
            let searchTimeout = null;
            const SEARCH_DELAY = 300; // Wait 300ms after user stops typing
            
            // Fetch claimants list from API (initial load - fallback to Supabase)
            async function loadClaimantsList() {
                try {
                    const response = await fetch('/api/claimants/list');
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        allClaimants = data.claimants || [];
                        console.log(`üî• Loaded ${allClaimants.length} claimant names (${data.source || 'supabase'})!`);
                        
                        // Populate the select element with options
                        const selectElement = document.querySelector('select.claimant-select');
                        if (selectElement) {
                            // Keep the current value option
                            const currentValue = selectElement.value;
                            
                            // Add all claimants as options
                            allClaimants.forEach(claimant => {
                                const option = document.createElement('option');
                                option.value = claimant;
                                option.textContent = claimant;
                                selectElement.appendChild(option);
                            });
                            
                            // Create the custom dropdown UI
                            createCustomDropdown();
                        }
                    }
                } catch (error) {
                    console.error('Error loading claimants:', error);
                }
            }
            
            // =============================================================================
            // üî• SALESFORCE SEARCH - FUTURE-PROOF FOR MATTER NAME SEARCH! 
            // =============================================================================
            // When Jai updates SOQL to search MatterName field, this will automatically work!
            // Current: Searches by claimant name (ClaimentName field in SOQL)
            // Future: Will search by matter name (MatterName field in SOQL) - NO CODE CHANGES NEEDED!
            // =============================================================================
            async function searchSalesforce(query, dropdown, ul) {
                try {
                    // Add loading indicator
                    ul.innerHTML = '<li class="option no-results"><i class="fa-solid fa-spinner fa-spin"></i> Searching Salesforce...</li>';
                    
                    const response = await fetch(`/api/salesforce/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    // üìä CLEAN TABLE VIEW - All Salesforce fields
                    if (data.raw_salesforce_response && data.raw_salesforce_response.length > 0) {
                        console.table(data.raw_salesforce_response);
                    }
                    
                    // Clear the list
                    ul.innerHTML = '';
                    
                    if (data.status === 'success' && data.results && data.results.length > 0) {
                        console.log(`‚úÖ Found ${data.total} matches from ${data.source}!`);

                        // =============================================================================
                        // üî• TABLE VIEW - Clean, scannable results
                        // =============================================================================
                        const table = document.createElement('table');
                        table.className = 'results-table';
                        table.style.fontSize = '12px'; // üî• Smaller font for better readability

                        // Table header
                        const thead = document.createElement('thead');
                        thead.innerHTML = `
                            <tr>
                                <th>Matter Name</th>
                                <th>Date of Birth</th>
                                <th>Stage</th>
                                <th>Claim Numbers</th>
                                <th>Policy Numbers</th>
                            </tr>
                        `;
                        table.appendChild(thead);

                        // Table body with results
                        const tbody = document.createElement('tbody');
                        data.results.forEach(item => {
                            const tr = document.createElement('tr');
                            tr.className = 'table-row-option';

                            // Store ALL data for auto-population
                            tr.setAttribute('data-value', item.matter_name);
                            tr.setAttribute('data-claimant', item.claimant || '');
                            tr.setAttribute('data-matter-id', item.matter_id || '');
                            tr.setAttribute('data-matter-url', item.matter_url || '');  // Salesforce URL
                            tr.setAttribute('data-date-of-birth', item.date_of_birth || '');
                            tr.setAttribute('data-stage', item.stage || '');
                            // Store insurance numbers as JSON string
                            tr.setAttribute('data-insurance-numbers', JSON.stringify(item.insurance_numbers || []));

                            // üî• Extract ALL claim numbers from insurance_numbers array
                            let claimNumbersText = '-';
                            if (item.insurance_numbers && item.insurance_numbers.length > 0) {
                                const claimNumbers = item.insurance_numbers
                                    .filter(ins => ins.type === 'claim' && ins.number)
                                    .map(ins => ins.number);
                                
                                if (claimNumbers.length > 0) {
                                    // Join with commas - wraps to multiple rows
                                    claimNumbersText = claimNumbers.join(', ');
                                }
                            }

                            // üî• Extract ALL policy numbers from insurance_numbers array
                            let policyNumbersText = '-';
                            if (item.insurance_numbers && item.insurance_numbers.length > 0) {
                                const policyNumbers = item.insurance_numbers
                                    .filter(ins => ins.type === 'policy' && ins.number)
                                    .map(ins => ins.number);
                                
                                if (policyNumbers.length > 0) {
                                    // Join with commas - wraps to multiple rows
                                    policyNumbersText = policyNumbers.join(', ');
                                }
                            }

                            // Create table cells with wrapping for claim/policy numbers
                            tr.innerHTML = `
                                <td style="font-weight: 500; font-size: 12.5px; max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 20px;" title="${item.matter_name || '-'}">${item.matter_name || '-'}</td>
                                <td class="text-gray">${item.date_of_birth || '-'}</td>
                                <td class="text-gray">${item.stage || '-'}</td>
                                <td class="text-gray" style="font-size: 12px; font-weight: 500; white-space: normal; word-wrap: break-word; max-width: 200px; line-height: 1.5;">${claimNumbersText}</td>
                                <td class="text-gray" style="font-size: 12px; font-weight: 500; white-space: normal; word-wrap: break-word; max-width: 200px; line-height: 1.5;">${policyNumbersText}</td>
                            `;

                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);

                        ul.appendChild(table);
                        console.log('üìã Results displayed in table format!');

                        // üî• Make search box match table width for proper scrolling
                        setTimeout(() => {
                            const searchBox = dropdown.querySelector('.dd-searchbox');
                            if (searchBox && table) {
                                const tableWidth = table.scrollWidth;
                                searchBox.style.width = tableWidth + 'px';
                                console.log('Search box width set to:', tableWidth + 'px');
                            }
                        }, 50);
                    } else {
                        // No results found
                        const noResults = document.createElement('li');
                        noResults.className = 'option no-results';
                        noResults.innerHTML = `<i class="fa-solid fa-search"></i> No matters found matching "${query}"`;
                        ul.appendChild(noResults);
                    }
                } catch (error) {
                    console.error('Salesforce search failed:', error);
                    
                    // Show error state
                    ul.innerHTML = '';
                    const errorLi = document.createElement('li');
                    errorLi.className = 'option no-results';
                    errorLi.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Search error - try again';
                    ul.appendChild(errorLi);
                }
            }

            // Create custom searchable dropdown for MATTER NAME
            function createCustomDropdown() {
                const selectElement = document.querySelector('select.matter-name-select');
                if (!selectElement || claimantDropdownCreated) return;

                claimantDropdownCreated = true;

                // üî• CREATE BACKDROP OVERLAY
                const backdrop = document.createElement('div');
                backdrop.className = 'dropdown-backdrop';
                backdrop.id = 'dropdownBackdrop';
                document.body.appendChild(backdrop);

                // Create dropdown container
                const dropdown = document.createElement('div');
                dropdown.className = 'dropdown-select wide';
                dropdown.setAttribute('tabindex', '0');
                
                // Current value display - MATTER NAME DROPDOWN! üî•
                const current = document.createElement('span');
                current.className = 'current';
                const selectedOption = selectElement.querySelector('option:checked') || selectElement.querySelector('option');
                current.textContent = selectedOption ? selectedOption.textContent : 'Search by matter name...';
                dropdown.appendChild(current);
                
                // List container
                const listDiv = document.createElement('div');
                listDiv.className = 'list';
                
                // Search box - MATTER NAME SEARCH! üî•
                const searchDiv = document.createElement('div');
                searchDiv.className = 'dd-search';
                const searchInput = document.createElement('input');
                searchInput.id = 'matterNameSearchBox';
                searchInput.className = 'dd-searchbox';
                searchInput.type = 'text';
                searchInput.placeholder = 'Search matter names...';
                searchInput.autocomplete = 'off';
                searchDiv.appendChild(searchInput);
                listDiv.appendChild(searchDiv);
                
                // Options list - START EMPTY, populate on search
                const ul = document.createElement('ul');

                // Show friendly prompt message instead of options
                const promptLi = document.createElement('li');
                promptLi.className = 'option no-results prompt-message';
                promptLi.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Type to search for matter names...';
                ul.appendChild(promptLi);

                listDiv.appendChild(ul);
                dropdown.appendChild(listDiv);
                
                // Insert after select element
                selectElement.parentNode.insertBefore(dropdown, selectElement.nextSibling);
                
                console.log('‚úÖ Searchable dropdown created!');
                
                // Setup event handlers
                setupDropdownEvents(dropdown, selectElement, searchInput, ul);
            }
            
            // Setup all dropdown event handlers
            function setupDropdownEvents(dropdown, selectElement, searchInput, ul) {
                const backdrop = document.getElementById('dropdownBackdrop');
                console.log('Backdrop element found:', backdrop);

                // Get left panel reference
                const leftPanel = document.getElementById('leftPanel');

                // Function to position dropdown to cover RIGHT panel (form fields)
                const positionDropdown = () => {
                    const rightPanel = document.getElementById('rightPanel');
                    const listElement = dropdown.querySelector('.list');

                    if (rightPanel && listElement && dropdown.classList.contains('open')) {
                        const rect = rightPanel.getBoundingClientRect();
                        // üî• Account for 2px left border on right panel
                        const borderWidth = 8;
                        listElement.style.width = (rect.width - borderWidth) + 'px';
                        listElement.style.left = (rect.left + borderWidth) + 'px'; // Move right by border width
                        listElement.style.top = (rect.top - 4) + 'px';
                        listElement.style.maxHeight = rect.height + 'px';
                    }
                };

                // Close dropdown helper
                const closeDropdown = () => {
                    // üî• DON'T CLOSE if search box still has focus
                    if (document.activeElement === searchInput) {
                        console.log('Search box has focus, keeping dropdown open');
                        return;
                    }

                    console.log('Closing dropdown and removing backdrop');
                    dropdown.classList.remove('open');
                    backdrop.classList.remove('show');

                    // üî• DELAY removing bright class from left panel until AFTER backdrop fade-out completes
                    // This prevents the strobing effect where left panel dims before backdrop fades
                    setTimeout(() => {
                        // Only remove bright class if search box is NOT focused
                        if (leftPanel && document.activeElement !== searchInput) {
                            leftPanel.classList.remove('left-panel-bright');
                        }
                    }, 300); // Match the backdrop transition duration (0.3s = 300ms)

                    ul.querySelectorAll('.option').forEach(opt => opt.removeAttribute('tabindex'));
                    document.body.style.overflow = ''; // Re-enable scrolling
                    console.log('Backdrop classes after close:', backdrop.className);
                };

                // Toggle dropdown open/close
                dropdown.addEventListener('click', function(event) {
                    if (event.target.matches('.dd-searchbox')) {
                        return; // Don't close when clicking search box
                    }

                    // Don't toggle if clicking on an option, table row, or inside them
                    if (event.target.closest('.option') || event.target.closest('tr.table-row-option') || event.target.closest('.results-table')) {
                        return; // Let the option/row click handler deal with it
                    }

                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-select').forEach(dd => {
                        if (dd !== dropdown) dd.classList.remove('open');
                    });

                    dropdown.classList.toggle('open');

                    if (dropdown.classList.contains('open')) {
                        // üî• POSITION DROPDOWN - Match left panel width dynamically
                        positionDropdown();

                        // üî• SHOW BACKDROP and disable body scroll
                        console.log('Adding backdrop show class', backdrop);
                        backdrop.classList.add('show');

                        // üî• BRIGHTEN LEFT PANEL - Keep PDF viewer above backdrop
                        if (leftPanel) leftPanel.classList.add('left-panel-bright');

                        console.log('Backdrop classes:', backdrop.className);
                        document.body.style.overflow = 'hidden';

                        ul.querySelectorAll('.option').forEach(opt => opt.setAttribute('tabindex', '0'));
                        const selected = ul.querySelector('.option.selected');
                        if (selected) selected.focus();
                        // Focus search box when opening
                        setTimeout(() => searchInput.focus(), 50);
                    } else {
                        closeDropdown();
                    }
                });

                // Close dropdown when clicking backdrop (dimmed grey areas)
                backdrop.addEventListener('click', closeDropdown);

                // Close dropdown when clicking outside - BUT NOT on left panel or divider
                document.addEventListener('click', function(event) {
                    // üî• DON'T CLOSE if we just finished dragging the panel divider
                    // This prevents accidental closes when releasing mouse after drag
                    if (justFinishedDragging) return;

                    // Don't close if clicking dropdown itself
                    if (dropdown.contains(event.target)) return;

                    // Don't close if clicking backdrop (it has its own handler)
                    if (event.target.matches('.dropdown-backdrop')) return;

                    // üî• DON'T CLOSE if clicking left panel (PDF viewer) - user needs to interact with PDF
                    if (leftPanel && leftPanel.contains(event.target)) return;

                    // üî• DON'T CLOSE if clicking panel divider - user needs to resize panels
                    const panelDivider = document.getElementById('panelDivider');
                    if (panelDivider && (event.target === panelDivider || panelDivider.contains(event.target))) return;

                    // Otherwise, close the dropdown
                    closeDropdown();
                });

                // üî• REPOSITION DROPDOWN ON WINDOW RESIZE AND PANEL DRAG
                window.addEventListener('resize', positionDropdown);
                window.addEventListener('panelResize', positionDropdown);
                
                // üî• ENSURE LEFT PANEL BRIGHTNESS WHEN CLICKING/FOCUSING SEARCH BOX
                const ensureDropdownOpen = function() {
                    if (!dropdown.classList.contains('open')) {
                        // Open the dropdown
                        dropdown.classList.add('open');

                        // Position dropdown
                        positionDropdown();

                        // Show backdrop and brighten left panel
                        backdrop.classList.add('show');
                        if (leftPanel) leftPanel.classList.add('left-panel-bright');

                        document.body.style.overflow = 'hidden';
                        ul.querySelectorAll('.option').forEach(opt => opt.setAttribute('tabindex', '0'));
                    } else {
                        // Dropdown is already open, but ensure left panel is bright
                        if (leftPanel && !leftPanel.classList.contains('left-panel-bright')) {
                            leftPanel.classList.add('left-panel-bright');
                        }
                    }
                };

                // Handle search box focus - ALWAYS open dropdown and brighten left panel
                searchInput.addEventListener('focus', ensureDropdownOpen);

                // Handle search box click - ALWAYS open dropdown and brighten left panel
                searchInput.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent dropdown click handler from interfering
                    ensureDropdownOpen();
                });

                // Handle search box blur - only close if clicking outside dropdown entirely
                searchInput.addEventListener('blur', function(event) {
                    // Use setTimeout to allow click events to process first
                    setTimeout(() => {
                        // Only close if the new focused element is not within the dropdown
                        const focusedElement = document.activeElement;
                        if (!dropdown.contains(focusedElement) && !backdrop.contains(focusedElement)) {
                            closeDropdown();
                        }
                    }, 150);
                });

                // DEBOUNCED SALESFORCE SEARCH - searches as user types!
                searchInput.addEventListener('keyup', function() {
                    const searchValue = this.value.trim();

                    // Clear previous timeout
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }

                    // If empty, show prompt message
                    if (searchValue.length === 0) {
                        ul.innerHTML = '';
                        const promptLi = document.createElement('li');
                        promptLi.className = 'option no-results prompt-message';
                        promptLi.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> Type to search for matter names...';
                        ul.appendChild(promptLi);
                        return;
                    }

                    // If less than 2 chars, show instruction
                    if (searchValue.length < 2) {
                        ul.innerHTML = '';
                        const instructionLi = document.createElement('li');
                        instructionLi.className = 'option no-results';
                        instructionLi.innerHTML = '<i class="fa-solid fa-keyboard"></i> Type at least 2 characters to search...';
                        ul.appendChild(instructionLi);
                        return;
                    }

                    // Wait for user to stop typing, THEN search Salesforce
                    searchTimeout = setTimeout(async () => {
                        await searchSalesforce(searchValue, dropdown, ul);
                    }, SEARCH_DELAY);
                });
                
                // Option selection - AUTO-POPULATE FIELDS FROM STORED DATA! üî•
                ul.addEventListener('click', async function(event) {
                    console.log('Click detected on:', event.target);

                    // Check if clicked on a table row or list option
                    const targetRow = event.target.closest('tr.table-row-option');
                    const targetOption = event.target.matches('.option') && !event.target.matches('.no-results') ? event.target : null;
                    const clickedElement = targetRow || targetOption;

                    console.log('Clicked element:', clickedElement);

                    if (clickedElement) {
                        console.log('Valid selection detected, processing...');
                        // Update selected state
                        ul.querySelectorAll('.option, tr.table-row-option').forEach(opt => opt.classList.remove('selected'));
                        clickedElement.classList.add('selected');

                        // Get data from attributes
                        const matterName = clickedElement.getAttribute('data-value');
                        const claimantName = clickedElement.getAttribute('data-claimant');
                        const matterId = clickedElement.getAttribute('data-matter-id');
                        const matterUrl = clickedElement.getAttribute('data-matter-url');

                        // Parse insurance numbers from JSON string
                        let insuranceNumbers = [];
                        try {
                            const insuranceData = clickedElement.getAttribute('data-insurance-numbers');
                            insuranceNumbers = insuranceData ? JSON.parse(insuranceData) : [];
                        } catch (e) {
                            console.error('Failed to parse insurance numbers:', e);
                            insuranceNumbers = [];
                        }

                        // Update display
                        dropdown.querySelector('.current').textContent = matterName;

                        // Update actual select value
                        selectElement.value = matterName;

                        // Trigger change event for validation
                        selectElement.dispatchEvent(new Event('change', { bubbles: true }));
                        selectElement.dispatchEvent(new Event('input', { bubbles: true }));

                        // üî• CLOSE DROPDOWN AND BACKDROP
                        console.log('About to close dropdown...');
                        closeDropdown();
                        console.log('Dropdown closed, backdrop should be hidden');

                        // =============================================================================
                        // AUTO-POPULATE ALL 3 FIELDS - Data already loaded! üöÄ
                        // =============================================================================
                        
                        // 1. Matter Name (update the hidden select properly!)
                        const matterNameInput = document.querySelector('select[name="matter_name"]');
                        if (matterNameInput) {
                            // IMPORTANT: We need to create/update an option with this value
                            // because select elements can only have values that match their options
                            let existingOption = Array.from(matterNameInput.options).find(opt => opt.value === matterName);
                            
                            if (!existingOption) {
                                // Create new option if it doesn't exist
                                const newOption = document.createElement('option');
                                newOption.value = matterName;
                                newOption.textContent = matterName;
                                newOption.selected = true;
                                matterNameInput.appendChild(newOption);
                            } else {
                                // Select existing option
                                existingOption.selected = true;
                            }
                            
                            // Now set the value
                            matterNameInput.value = matterName;
                            matterNameInput.dispatchEvent(new Event('change', { bubbles: true }));
                            matterNameInput.dispatchEvent(new Event('input', { bubbles: true }));
                            matterNameInput.classList.add('field-salesforce');
                        }
                        
                        // 2. Claimant
                        if (claimantName) {
                            const claimantInput = document.querySelector('input[name="claimant"]');
                            if (claimantInput) {
                                claimantInput.value = claimantName;
                                claimantInput.dispatchEvent(new Event('change', { bubbles: true }));
                                claimantInput.dispatchEvent(new Event('input', { bubbles: true }));
                                claimantInput.classList.add('field-salesforce');
                            }
                        }
                        
                        // 3. Matter ID - Make it clickable if we have a URL
                        if (matterId) {
                            const matterIdInput = document.querySelector('input[name="matter_id"]');
                            if (matterIdInput) {
                                matterIdInput.value = matterId;
                                matterIdInput.dispatchEvent(new Event('change', { bubbles: true }));
                                matterIdInput.dispatchEvent(new Event('input', { bubbles: true }));
                                matterIdInput.classList.add('field-salesforce');

                                console.log('üîó Matter ID:', matterId);
                                console.log('üîó Matter URL:', matterUrl);
                                console.log('üîó Matter URL type:', typeof matterUrl);
                                console.log('üîó Matter URL truthy?', !!matterUrl);

                                // Make the input clickable if we have a URL
                                if (matterUrl) {
                                    console.log('‚úÖ Making Matter ID clickable with URL:', matterUrl);
                                    // Store the URL in a data attribute
                                    matterIdInput.setAttribute('data-matter-url', matterUrl);

                                    // Add visual cue that it's clickable
                                    matterIdInput.style.cursor = 'pointer';
                                    matterIdInput.style.color = '#3b82f6';  // Blue color
                                    matterIdInput.style.textDecoration = 'underline';
                                    matterIdInput.title = 'Click to open in Salesforce';

                                    // Remove any existing click handlers to avoid duplicates
                                    const newInput = matterIdInput.cloneNode(true);
                                    matterIdInput.parentNode.replaceChild(newInput, matterIdInput);

                                    // Add click handler to open Salesforce URL
                                    newInput.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        const url = this.getAttribute('data-matter-url');
                                        if (url) {
                                            window.open(url, '_blank');
                                            console.log('Opening Salesforce matter:', url);
                                        }
                                    });

                                    // Prevent text selection when clicking
                                    newInput.addEventListener('mousedown', function(e) {
                                        if (!e.shiftKey) {
                                            e.preventDefault();
                                        }
                                    });
                                }
                            }
                        }

                        // 4. üî• POPULATE SALESFORCE INSURANCE BOX (Right side) - Not left side!
                        
                        // üßπ CLEAR PREVIOUS SALESFORCE INSURANCE DATA FIRST!
                        // This ensures old data doesn't persist when selecting a new matter
                        const clearSalesforceInsuranceFields = () => {
                            console.log('üßπ Clearing previous Salesforce Insurance fields...');
                            
                            // Clear all three RIGHT side fields
                            const insuranceCompanyInput = document.querySelector('input[name="insurance_company"]');
                            const sfClaimNumberInput = document.querySelector('input[name="sf_claim_number"]');
                            const sfPolicyNumberInput = document.querySelector('input[name="sf_policy_number"]');
                            
                            [insuranceCompanyInput, sfClaimNumberInput, sfPolicyNumberInput].forEach(input => {
                                if (input) {
                                    input.value = '';
                                    delete input.dataset.insuranceId;
                                    delete input.dataset.companyId;
                                    input.classList.remove('field-salesforce');
                                    
                                    // Remove existing dropdown wrappers
                                    const existingWrapper = input.parentElement?.classList.contains('insurance-dropdown-wrapper')
                                        ? input.parentElement
                                        : null;
                                    
                                    if (existingWrapper) {
                                        const parent = existingWrapper.parentElement;
                                        parent.insertBefore(input, existingWrapper);
                                        existingWrapper.remove();
                                        input.style.paddingRight = ''; // Reset padding
                                    }
                                }
                            });
                            
                            // Clear global state
                            window.currentInsuranceRecords = [];
                            
                            console.log('‚úÖ Salesforce Insurance fields cleared');
                        };
                        
                        // Always clear first before processing new data
                        clearSalesforceInsuranceFields();
                        
                        if (insuranceNumbers && insuranceNumbers.length > 0) {
                            console.log('üíº Found insurance numbers:', insuranceNumbers);

                            // üî• Group insurance data by InsuranceId (each insurance record has claim + policy)
                            // This creates linked records: Company ‚Üí Claim Number + Policy Number
                            const insuranceRecordsMap = new Map();
                            
                            insuranceNumbers.forEach(ins => {
                                const insuranceId = ins.insurance_id;
                                const companyName = ins.insurance_company_name;
                                const companyId = ins.insurance_company_id;
                                
                                if (!insuranceRecordsMap.has(insuranceId)) {
                                    insuranceRecordsMap.set(insuranceId, {
                                        insurance_id: insuranceId,
                                        company_name: companyName,
                                        company_id: companyId,
                                        claim_number: null,
                                        policy_number: null
                                    });
                                }
                                
                                const record = insuranceRecordsMap.get(insuranceId);
                                if (ins.type === 'claim' && ins.number) {
                                    record.claim_number = ins.number;
                                } else if (ins.type === 'policy' && ins.number) {
                                    record.policy_number = ins.number;
                                }
                            });
                            
                            // Convert to array for easier handling
                            const insuranceRecords = Array.from(insuranceRecordsMap.values());
                            console.log('üè¢ Linked insurance records:', insuranceRecords);
                            
                            // Store globally so dropdown click handlers can access it
                            window.currentInsuranceRecords = insuranceRecords;

                            // üéØ NO AUTO-POPULATION - We'll add DROPDOWNS to RIGHT side instead!
                            // Users select from dropdown on the Salesforce Insurance box

                            // Function to add dropdown wrapper to input (for LEFT side Provider & Claims if still needed)
                            const addInsuranceDropdown = (inputElement, numbers, type) => {
                                if (!inputElement || numbers.length === 0) return;

                                // Remove any existing wrapper
                                const existingWrapper = inputElement.parentElement.classList.contains('insurance-dropdown-wrapper')
                                    ? inputElement.parentElement
                                    : null;

                                if (existingWrapper) {
                                    const parent = existingWrapper.parentElement;
                                    parent.insertBefore(inputElement, existingWrapper);
                                    existingWrapper.remove();
                                }

                                // Create wrapper container
                                const wrapper = document.createElement('div');
                                wrapper.className = 'insurance-dropdown-wrapper';
                                wrapper.style.position = 'relative';
                                wrapper.style.width = '100%';

                                // Wrap the input
                                inputElement.parentNode.insertBefore(wrapper, inputElement);
                                wrapper.appendChild(inputElement);

                                // Modify input to make room for dropdown button
                                inputElement.style.paddingRight = '35px';

                                // Create dropdown button/icon
                                const dropdownBtn = document.createElement('button');
                                dropdownBtn.type = 'button';
                                dropdownBtn.className = 'insurance-dropdown-btn';
                                dropdownBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>';
                                dropdownBtn.title = `View ${numbers.length} Salesforce ${type} number${numbers.length > 1 ? 's' : ''}`;
                                dropdownBtn.style.position = 'absolute';
                                dropdownBtn.style.right = '8px';
                                dropdownBtn.style.top = '50%';
                                dropdownBtn.style.transform = 'translateY(-50%)';
                                dropdownBtn.style.background = 'transparent';
                                dropdownBtn.style.color = '#64748b';
                                dropdownBtn.style.border = 'none';
                                dropdownBtn.style.borderRadius = '4px';
                                dropdownBtn.style.width = '22px';
                                dropdownBtn.style.height = '22px';
                                dropdownBtn.style.cursor = 'pointer';
                                dropdownBtn.style.display = 'flex';
                                dropdownBtn.style.alignItems = 'center';
                                dropdownBtn.style.justifyContent = 'center';
                                dropdownBtn.style.zIndex = '10';
                                dropdownBtn.style.transition = 'all 0.2s';

                                // Hover effect
                                dropdownBtn.addEventListener('mouseenter', () => {
                                    dropdownBtn.style.background = '#f1f5f9';
                                    dropdownBtn.style.color = '#3b82f6';
                                });
                                dropdownBtn.addEventListener('mouseleave', () => {
                                    dropdownBtn.style.background = 'transparent';
                                    dropdownBtn.style.color = '#64748b';
                                });

                                // Create dropdown list
                                const dropdownList = document.createElement('div');
                                dropdownList.className = 'insurance-dropdown-list';
                                dropdownList.style.position = 'absolute';
                                dropdownList.style.top = 'calc(100% + 4px)';
                                dropdownList.style.left = '0';
                                dropdownList.style.right = '0';
                                dropdownList.style.background = 'white';
                                dropdownList.style.border = '1px solid #cbd5e1';
                                dropdownList.style.borderRadius = '6px';
                                dropdownList.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                                dropdownList.style.maxHeight = '200px';
                                dropdownList.style.overflowY = 'auto';
                                dropdownList.style.zIndex = '1000';
                                dropdownList.style.display = 'none';

                                // Add header
                                const header = document.createElement('div');
                                const headerText = type === 'company' ? 'Insurance Companies' : `Salesforce ${type} numbers`;
                                header.textContent = headerText;
                                header.style.padding = '8px 12px';
                                header.style.background = '#f1f5f9';
                                header.style.borderBottom = '1px solid #cbd5e1';
                                header.style.fontWeight = 'bold';
                                header.style.fontSize = '12px';
                                header.style.color = '#475569';
                                dropdownList.appendChild(header);

                                // Add insurance items (numbers or companies)
                                numbers.forEach(ins => {
                                    const item = document.createElement('div');
                                    
                                    // Display name based on type
                                    if (type === 'company') {
                                        item.textContent = ins.name; // Show company name
                                        item.dataset.insuranceId = ins.insurance_id; // Store InsuranceId
                                        item.dataset.companyId = ins.company_id; // Store Company Id
                                    } else {
                                        item.textContent = ins.number; // Show claim/policy number
                                        item.dataset.insuranceId = ins.insurance_id;
                                    }
                                    
                                    item.style.padding = '8px 12px';
                                    item.style.fontSize = '13px';
                                    item.style.borderBottom = '1px solid #f1f5f9';
                                    item.style.cursor = 'pointer';
                                    item.style.transition = 'background 0.15s';

                                    item.addEventListener('mouseenter', () => {
                                        item.style.background = '#f8fafc';
                                    });
                                    item.addEventListener('mouseleave', () => {
                                        item.style.background = 'white';
                                    });
                                    
                                    // Click to select
                                    item.addEventListener('click', () => {
                                        // üî• CRITICAL FIX: Use the data directly from 'ins' object (already has all linked fields)
                                        // No need to search window.currentInsuranceRecords anymore!
                                        
                                        console.log('üîç Dropdown item clicked:', { type, ins });
                                        
                                        if (type === 'company') {
                                            // üî• LINKED SELECTION: Selecting company updates claim AND policy numbers!
                                            // Update Insurance Company field
                                            inputElement.value = ins.company_name || ins.name;
                                            inputElement.dataset.insuranceId = ins.insurance_id;
                                            inputElement.dataset.companyId = ins.company_id;
                                            inputElement.classList.add('field-salesforce');
                                            
                                            // üéØ AUTO-UPDATE linked Claim Number field
                                            const claimInput = document.querySelector('input[name="sf_claim_number"]');
                                            if (claimInput && ins.claim_number) {
                                                claimInput.value = ins.claim_number;
                                                claimInput.dataset.insuranceId = ins.insurance_id;
                                                claimInput.classList.add('field-salesforce');
                                                claimInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            }
                                            
                                            // üéØ AUTO-UPDATE linked Policy Number field
                                            const policyInput = document.querySelector('input[name="sf_policy_number"]');
                                            if (policyInput && ins.policy_number) {
                                                policyInput.value = ins.policy_number;
                                                policyInput.dataset.insuranceId = ins.insurance_id;
                                                policyInput.classList.add('field-salesforce');
                                                policyInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            }
                                            
                                            console.log('üîó COMPANY SELECTED - LINKED UPDATE:', {
                                                company: ins.company_name || ins.name,
                                                claim: ins.claim_number,
                                                policy: ins.policy_number,
                                                insuranceId: ins.insurance_id
                                            });
                                            
                                        } else if (type === 'claim') {
                                            // üî• BIDIRECTIONAL LINKING: Selecting claim number updates company AND policy!
                                            // Update Claim Number field
                                            inputElement.value = ins.claim_number || ins.number;
                                            inputElement.dataset.insuranceId = ins.insurance_id;
                                            inputElement.classList.add('field-salesforce');
                                            
                                            // üéØ AUTO-UPDATE linked Insurance Company field
                                            const companyInput = document.querySelector('input[name="insurance_company"]');
                                            if (companyInput && ins.company_name) {
                                                companyInput.value = ins.company_name;
                                                companyInput.dataset.insuranceId = ins.insurance_id;
                                                companyInput.dataset.companyId = ins.company_id;
                                                companyInput.classList.add('field-salesforce');
                                                companyInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            }
                                            
                                            // üéØ AUTO-UPDATE linked Policy Number field
                                            const policyInput = document.querySelector('input[name="sf_policy_number"]');
                                            if (policyInput && ins.policy_number) {
                                                policyInput.value = ins.policy_number;
                                                policyInput.dataset.insuranceId = ins.insurance_id;
                                                policyInput.classList.add('field-salesforce');
                                                policyInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            }
                                            
                                            console.log('üîó CLAIM SELECTED - LINKED UPDATE:', {
                                                claim: ins.claim_number || ins.number,
                                                company: ins.company_name,
                                                policy: ins.policy_number,
                                                insuranceId: ins.insurance_id
                                            });
                                            
                                        } else if (type === 'policy') {
                                            // üî• BIDIRECTIONAL LINKING: Selecting policy number updates company AND claim!
                                            // Update Policy Number field
                                            inputElement.value = ins.policy_number || ins.number;
                                            inputElement.dataset.insuranceId = ins.insurance_id;
                                            inputElement.classList.add('field-salesforce');
                                            
                                            // üéØ AUTO-UPDATE linked Insurance Company field
                                            const companyInput = document.querySelector('input[name="insurance_company"]');
                                            if (companyInput && ins.company_name) {
                                                companyInput.value = ins.company_name;
                                                companyInput.dataset.insuranceId = ins.insurance_id;
                                                companyInput.dataset.companyId = ins.company_id;
                                                companyInput.classList.add('field-salesforce');
                                                companyInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            }
                                            
                                            // üéØ AUTO-UPDATE linked Claim Number field
                                            const claimInput = document.querySelector('input[name="sf_claim_number"]');
                                            if (claimInput && ins.claim_number) {
                                                claimInput.value = ins.claim_number;
                                                claimInput.dataset.insuranceId = ins.insurance_id;
                                                claimInput.classList.add('field-salesforce');
                                                claimInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            }
                                            
                                            console.log('üîó POLICY SELECTED - LINKED UPDATE:', {
                                                policy: ins.policy_number || ins.number,
                                                company: ins.company_name,
                                                claim: ins.claim_number,
                                                insuranceId: ins.insurance_id
                                            });
                                            
                                        } else {
                                            // Fallback for any other type
                                            inputElement.value = ins.number || ins.name;
                                            inputElement.dataset.insuranceId = ins.insurance_id;
                                            inputElement.classList.add('field-salesforce');
                                        }
                                        
                                        inputElement.dispatchEvent(new Event('change', { bubbles: true }));
                                        dropdownList.style.display = 'none';
                                        dropdownBtn.innerHTML = chevronDown;
                                        console.log(`‚úÖ Selected ${type}:`, inputElement.value, 'InsuranceId:', ins.insurance_id);
                                    });

                                    dropdownList.appendChild(item);
                                });

                                wrapper.appendChild(dropdownBtn);
                                wrapper.appendChild(dropdownList);

                                // Toggle dropdown on button click
                                const chevronDown = '<svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>';
                                const chevronUp = '<svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>';

                                dropdownBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const isOpen = dropdownList.style.display === 'block';

                                    // Close all other insurance dropdowns
                                    document.querySelectorAll('.insurance-dropdown-list').forEach(dl => {
                                        dl.style.display = 'none';
                                    });
                                    document.querySelectorAll('.insurance-dropdown-btn').forEach(btn => {
                                        btn.innerHTML = chevronDown;
                                    });

                                    dropdownList.style.display = isOpen ? 'none' : 'block';
                                    dropdownBtn.innerHTML = isOpen ? chevronDown : chevronUp;
                                });

                                // Close dropdown when clicking outside
                                const chevronDownSvg = '<svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>';
                                document.addEventListener('click', (e) => {
                                    if (!wrapper.contains(e.target)) {
                                        dropdownList.style.display = 'none';
                                        dropdownBtn.innerHTML = chevronDownSvg;
                                    }
                                });

                                console.log(`‚úÖ ${type} number Salesforce view dropdown integrated`);
                            };

                            // üî• ADD DROPDOWNS TO RIGHT SIDE (Salesforce Insurance box)
                            // Users select from Salesforce insurance options on the RIGHT side
                            
                            // 1. Insurance Company dropdown (MASTER dropdown - updates claim + policy when selected)
                            const insuranceCompanyInput = document.querySelector('input[name="insurance_company"]');
                            if (insuranceRecords.length > 0 && insuranceCompanyInput) {
                                // üéØ PASS FULL RECORD DATA so click handler can link fields properly
                                const companyDropdownItems = insuranceRecords.map(rec => ({
                                    name: rec.company_name,
                                    insurance_id: rec.insurance_id,
                                    company_id: rec.company_id,
                                    // üî• INCLUDE ALL LINKED DATA for proper selection
                                    claim_number: rec.claim_number,
                                    policy_number: rec.policy_number,
                                    company_name: rec.company_name
                                }));
                                addInsuranceDropdown(insuranceCompanyInput, companyDropdownItems, 'company');
                                console.log('‚úÖ Added LINKED dropdown to RIGHT side Insurance Company');
                            }
                            
                            // 2. SF Claim Number dropdown (Read-only display - updated by company selection)
                            const sfClaimNumberInput = document.querySelector('input[name="sf_claim_number"]');
                            if (insuranceRecords.length > 0 && sfClaimNumberInput) {
                                // üéØ PASS FULL RECORD DATA so click handler can link fields properly
                                const claimDropdownItems = insuranceRecords
                                    .filter(rec => rec.claim_number)
                                    .map(rec => ({
                                        number: rec.claim_number,
                                        insurance_id: rec.insurance_id,
                                        // üî• INCLUDE ALL LINKED DATA for proper selection
                                        claim_number: rec.claim_number,
                                        policy_number: rec.policy_number,
                                        company_name: rec.company_name,
                                        company_id: rec.company_id
                                    }));
                                if (claimDropdownItems.length > 0) {
                                    addInsuranceDropdown(sfClaimNumberInput, claimDropdownItems, 'claim');
                                    console.log('‚úÖ Added dropdown to RIGHT side SF Claim Number');
                                }
                            }
                            
                            // 3. SF Policy Number dropdown (Read-only display - updated by company selection)
                            const sfPolicyNumberInput = document.querySelector('input[name="sf_policy_number"]');
                            if (insuranceRecords.length > 0 && sfPolicyNumberInput) {
                                // üéØ PASS FULL RECORD DATA so click handler can link fields properly
                                const policyDropdownItems = insuranceRecords
                                    .filter(rec => rec.policy_number)
                                    .map(rec => ({
                                        number: rec.policy_number,
                                        insurance_id: rec.insurance_id,
                                        // üî• INCLUDE ALL LINKED DATA for proper selection
                                        claim_number: rec.claim_number,
                                        policy_number: rec.policy_number,
                                        company_name: rec.company_name,
                                        company_id: rec.company_id
                                    }));
                                if (policyDropdownItems.length > 0) {
                                    addInsuranceDropdown(sfPolicyNumberInput, policyDropdownItems, 'policy');
                                    console.log('‚úÖ Added dropdown to RIGHT side SF Policy Number');
                                }
                            }
                            
                            console.log('‚úÖ All LINKED insurance dropdowns added to RIGHT SIDE Salesforce Insurance box');

                        } else {
                            console.log('‚ÑπÔ∏è No insurance numbers found from Salesforce');
                        }

                        // Validate after auto-population
                        setTimeout(validateQuickApprove, 0);
                    }
                });
                
                // Keyboard navigation
                dropdown.addEventListener('keydown', function(event) {
                    const focused = ul.querySelector('.option:focus') || ul.querySelector('.option.selected');
                    
                    if (event.keyCode == 13) { // Enter
                        if (dropdown.classList.contains('open')) {
                            if (focused && !focused.matches('.no-results')) {
                                focused.click();
                            }
                        } else {
                            dropdown.click();
                        }
                        event.preventDefault();
                    } else if (event.keyCode == 40) { // Down arrow
                        if (!dropdown.classList.contains('open')) {
                            dropdown.click();
                        } else if (focused) {
                            let next = focused.nextElementSibling;
                            while (next && next.style.display === 'none') {
                                next = next.nextElementSibling;
                            }
                            if (next) next.focus();
                        }
                        event.preventDefault();
                    } else if (event.keyCode == 38) { // Up arrow
                        if (!dropdown.classList.contains('open')) {
                            dropdown.click();
                        } else if (focused) {
                            let prev = focused.previousElementSibling;
                            while (prev && prev.style.display === 'none') {
                                prev = prev.previousElementSibling;
                            }
                            if (prev) prev.focus();
                        }
                        event.preventDefault();
                    } else if (event.keyCode == 27) { // Escape
                        if (dropdown.classList.contains('open')) {
                            dropdown.click();
                        }
                        event.preventDefault();
                    }
                });
            }
            
            // Initialize dropdown on page load
            loadClaimantsList();
            
            // ============================================================================
            // FIELD HIGHLIGHTING - Clean & Professional üé®
            // ============================================================================
            function applyFieldHighlights() {
                // Helper function to check if field has real data
                function hasRealData(value) {
                    if (!value) return false;
                    const trimmed = value.trim();
                    if (trimmed === '') return false;
                    if (trimmed.toLowerCase() === 'none') return false;
                    if (trimmed.toLowerCase() === 'null') return false;
                    if (trimmed === '0' || trimmed === '0.00' || trimmed === '$0.00') return false;
                    return true;
                }
                
                // Salesforce-pulled fields (blue highlight) - top 3 fields
                const salesforceFields = ['matter_name', 'matter_id', 'claimant'];
                
                // All other extracted fields (green highlight)
                const extractedFields = [
                    'pay_to', 'amount', 'check_issue_date', 'date_of_loss',
                    'check_number', 'routing_number', 'account_number', 'memo',
                    'provider_name', 'claim_number', 'policy_number', 'check_type',
                    'case_type', 'delivery_service', 'insurance_company',
                    'reference_number', 'bank_name', 'insured_name', 'extraction_notes'
                ];
                
                // Apply blue highlights to Salesforce fields if they have REAL data
                salesforceFields.forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field && hasRealData(field.value)) {
                        field.classList.add('field-salesforce');
                    }
                });
                
                // Apply green highlights to extracted fields if they have REAL data
                extractedFields.forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field && hasRealData(field.value)) {
                        field.classList.add('field-extracted');
                    }
                });
            }
            
            // Apply highlights on page load
            applyFieldHighlights();
            
            // ============================================================================
            // QUICK APPROVE VALIDATION - Require Salesforce fields üîí
            // ============================================================================
            function validateQuickApprove() {
                // Helper function to check if field has real data (same as highlights)
                function hasRealData(value) {
                    if (!value) return false;
                    const trimmed = value.trim();
                    if (trimmed === '') return false;
                    if (trimmed.toLowerCase() === 'none') return false;
                    if (trimmed.toLowerCase() === 'null') return false;
                    if (trimmed === '0' || trimmed === '0.00' || trimmed === '$0.00') return false;
                    return true;
                }
                
                // Get the three required Salesforce fields
                const matterNameField = document.querySelector('[name="matter_name"]');
                const matterIdField = document.querySelector('[name="matter_id"]');
                const claimantField = document.querySelector('[name="claimant"]');
                const quickApproveBtn = document.getElementById('quickApprove');
                
                if (!quickApproveBtn) return;
                
                // Check if all three have real data
                const matterNameValid = matterNameField && hasRealData(matterNameField.value);
                const matterIdValid = matterIdField && hasRealData(matterIdField.value);
                const claimantValid = claimantField && hasRealData(claimantField.value);
                const allFieldsValid = matterNameValid && matterIdValid && claimantValid;
                
                if (allFieldsValid) {
                    // Enable Quick Approve
                    quickApproveBtn.disabled = false;
                    quickApproveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    quickApproveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    quickApproveBtn.title = 'All required Salesforce fields populated - ready to approve';
                } else {
                    // Disable Quick Approve
                    quickApproveBtn.disabled = true;
                    quickApproveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    quickApproveBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    
                    const missingFields = [];
                    if (!matterNameValid) missingFields.push('Matter Name');
                    if (!matterIdValid) missingFields.push('Matter ID');
                    if (!claimantValid) missingFields.push('Claimant');
                    
                    quickApproveBtn.title = `Cannot approve: Missing Salesforce data (${missingFields.join(', ')})`;
                }
            }
            
            // Run validation on page load
            validateQuickApprove();
            
            // Re-validate when any of the required fields change
            // Use setTimeout to defer validation until after auto-population completes
            ['matter_name', 'matter_id', 'claimant'].forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    field.addEventListener('input', () => setTimeout(validateQuickApprove, 0));
                    field.addEventListener('change', () => setTimeout(validateQuickApprove, 0));
                }
            });

            // ============================================================================
            // MATTER ID CLICKABLE LINK - Initialize on page load
            // ============================================================================
            (function initializeMatterIdLink() {
                const matterIdInput = document.querySelector('input[name="matter_id"]');
                const matterUrl = '{{ check.matter_url or "" }}';

                console.log('üîç Matter ID initialization:', {
                    hasInput: !!matterIdInput,
                    matterUrl: matterUrl,
                    matterIdValue: matterIdInput ? matterIdInput.value : 'N/A',
                    allConditionsMet: !!(matterIdInput && matterUrl && matterIdInput.value)
                });

                if (matterIdInput && matterUrl && matterIdInput.value) {
                    // Make Matter ID clickable
                    matterIdInput.setAttribute('data-matter-url', matterUrl);
                    matterIdInput.style.cursor = 'pointer';
                    matterIdInput.style.color = '#3b82f6';  // Blue color
                    matterIdInput.style.textDecoration = 'underline';
                    matterIdInput.title = 'Click to open in Salesforce';

                    // Add click handler
                    matterIdInput.addEventListener('click', function(e) {
                        e.preventDefault();
                        const url = this.getAttribute('data-matter-url');
                        if (url) {
                            window.open(url, '_blank');
                        }
                    });

                    console.log('‚úÖ Matter ID link initialized on page load');
                } else {
                    console.log('‚ùå Matter ID link NOT initialized - missing required data');
                }
            })();

            // ============================================================================
            // PDF.js RENDERING SYSTEM - BLAZING FAST! üî•
            // ============================================================================
            const pdfCanvas = document.getElementById('pdfCanvas');
            const pdfLoading = document.getElementById('pdfLoading');
            const pdfError = document.getElementById('imageError');
            let currentPdfDoc = null;
            let currentPdfPage = null;
            
            // PRELOADING CACHE - Load next/prev PDFs in background! üöÄ
            const pdfCache = new Map();
            let preloadAbortController = null;
            
            // Update form fields with extracted data - GLOBAL FUNCTION
            function updateFormWithExtractedData(extractedData) {
                const fieldMappings = {
                    'claimant': extractedData.claimant,
                    'pay_to': extractedData.pay_to,
                    'amount': extractedData.amount,
                    'check_issue_date': extractedData.check_issue_date,
                    'date_of_loss': extractedData.date_of_loss,
                    'check_number': extractedData.check_number,
                    'routing_number': extractedData.routing_number,
                    'account_number': extractedData.account_number,
                    'memo': extractedData.memo,
                    'provider_name': extractedData.provider_name || extractedData.insurance_company,
                    'claim_number': extractedData.claim_number,
                    'policy_number': extractedData.policy_number
                };
                
                Object.entries(fieldMappings).forEach(([fieldName, value]) => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // PRELOAD PDFs in background - NO MORE WAITING! üî•
            async function preloadPDF(pageIndex) {
                if (!batchImages || pageIndex < 0 || pageIndex >= batchImages.length) return;
                
                const checkId = '{{ check.id }}';
                const pdfUrl = `/checks/pdf/${checkId}/${pageIndex}`;
                
                // Skip if already cached
                if (pdfCache.has(pdfUrl)) {
                    console.log('PDF already cached:', pageIndex);
                    return;
                }
                
                console.log('üîÑ Preloading PDF in background:', pageIndex);
                
                try {
                    const loadingTask = pdfjsLib.getDocument({
                        url: pdfUrl,
                        cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                        cMapPacked: true,
                        disableAutoFetch: true,
                        disableStream: false,
                        useSystemFonts: true
                    });
                    
                    const pdfDoc = await loadingTask.promise;
                    const pdfPage = await pdfDoc.getPage(1);
                    
                    // Cache the loaded PDF doc and page
                    pdfCache.set(pdfUrl, { doc: pdfDoc, page: pdfPage });
                    console.log('‚úÖ PDF cached:', pageIndex);
                } catch (error) {
                    // Preload failures are not critical - just log and continue
                    console.warn(`‚ö†Ô∏è Preload failed for page ${pageIndex}:`, error.message || error);
                    // Don't show error to user - they'll see it if they navigate to that page
                }
            }
            
            // Preload adjacent pages when user views a page
            function preloadAdjacentPages(currentIndex) {
                // Cancel any in-progress preload
                if (preloadAbortController) {
                    preloadAbortController.abort();
                }
                preloadAbortController = new AbortController();
                
                // Preload next page (most likely to be viewed)
                if (currentIndex + 1 < batchImages.length) {
                    preloadPDF(currentIndex + 1);
                }
                
                // Preload previous page (might go back)
                if (currentIndex - 1 >= 0) {
                    preloadPDF(currentIndex - 1);
                }
                
                // Preload 2 pages ahead for fast users
                if (currentIndex + 2 < batchImages.length) {
                    setTimeout(() => preloadPDF(currentIndex + 2), 500);
                }
            }
            
            // PDF Rendering function - NOW WITH INSTANT CACHE! ‚ö°
            async function renderPDF(pageIndex = 0) {
                if (!batchImages || batchImages.length === 0) {
                    console.warn('No PDF pages available');
                    if (pdfLoading) pdfLoading.style.display = 'none';
                    if (pdfError) pdfError.style.display = 'flex';
                    return;
                }
                
                try {
                    const startTime = performance.now();
                    
                    // Show loading indicator
                    if (pdfLoading) pdfLoading.style.display = 'flex';
                    if (pdfError) pdfError.style.display = 'none';
                    
                    const currentImg = batchImages[pageIndex];
                    const checkId = '{{ check.id }}';
                    const pdfUrl = `/checks/pdf/${checkId}/${pageIndex}`;
                    
                    // CHECK CACHE FIRST! üöÄ
                    let pdfDoc, pdfPage;
                    if (pdfCache.has(pdfUrl)) {
                        console.log('üí® INSTANT LOAD from cache!', pageIndex);
                        const cached = pdfCache.get(pdfUrl);
                        pdfDoc = cached.doc;
                        pdfPage = cached.page;
                    } else {
                        // Not cached - load it now
                        console.log('Loading PDF:', pdfUrl);
                        
                        const loadingTask = pdfjsLib.getDocument({
                            url: pdfUrl,
                            cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                            cMapPacked: true,
                            disableAutoFetch: true,
                            disableStream: false,
                            disableFontFace: false,
                            useSystemFonts: true
                        });
                        
                        pdfDoc = await loadingTask.promise;
                        pdfPage = await pdfDoc.getPage(1);
                        
                        // Cache it for next time
                        pdfCache.set(pdfUrl, { doc: pdfDoc, page: pdfPage });
                        
                        console.log('PDF loaded in', Math.round(performance.now() - startTime), 'ms');
                    }
                    
                    currentPdfDoc = pdfDoc;
                    currentPdfPage = pdfPage;
                    
                    // MAXIMUM CLARITY: Use 2.0x scale for sharpest rendering!
                    // This is retina-quality - super crisp text
                    const viewport = pdfPage.getViewport({ scale: 2.0 });
                    
                    // Set canvas dimensions
                    pdfCanvas.width = viewport.width;
                    pdfCanvas.height = viewport.height;
                    pdfCanvas.style.width = (viewport.width / 2.0) + 'px';
                    pdfCanvas.style.height = (viewport.height / 2.0) + 'px';
                    
                    // Render PDF page to canvas with optimized settings
                    const context = pdfCanvas.getContext('2d', {
                        alpha: false,
                        desynchronized: true
                    });
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport,
                        intent: 'display',
                        renderInteractiveForms: false,
                        enableWebGL: true
                    };
                    
                    await pdfPage.render(renderContext).promise;
                    
                    const totalTime = Math.round(performance.now() - startTime);
                    console.log('PDF rendered in', totalTime, 'ms TOTAL');
                    
                    // Hide loading
                    if (pdfLoading) pdfLoading.style.display = 'none';
                    
                    // Update form with extracted data if available
                    if (currentImg.extracted_data) {
                        updateFormWithExtractedData(currentImg.extracted_data);
                    }
                    
                    // PRELOAD ADJACENT PAGES IN BACKGROUND! üöÄ
                    preloadAdjacentPages(pageIndex);
                    
                } catch (error) {
                    console.error('‚ùå PDF rendering error:', error);
                    console.error('Error type:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Stack trace:', error.stack);
                    
                    // Hide loading
                    if (pdfLoading) pdfLoading.style.display = 'none';
                    
                    // Show detailed error to user
                    if (pdfError) {
                        pdfError.style.display = 'flex';
                        
                        // Update error message with details
                        const errorTitle = pdfError.querySelector('h3');
                        const errorDesc = pdfError.querySelector('p');
                        
                        if (error.name === 'UnexpectedResponseException') {
                            if (errorTitle) errorTitle.textContent = 'PDF Loading Failed';
                            if (errorDesc) errorDesc.innerHTML = `
                                <strong>Server Error (500)</strong><br>
                                The server encountered an error loading this PDF.<br>
                                <span class="text-xs">Check: ${checkId}, Page: ${pageIndex}</span>
                            `;
                        } else if (error.message && error.message.includes('404')) {
                            if (errorTitle) errorTitle.textContent = 'PDF Not Found';
                            if (errorDesc) errorDesc.textContent = 'This PDF file could not be found in storage.';
                        } else if (error.message && error.message.includes('NetworkError')) {
                            if (errorTitle) errorTitle.textContent = 'Network Error';
                            if (errorDesc) errorDesc.textContent = 'Could not connect to server. Check your internet connection.';
                        } else {
                            if (errorTitle) errorTitle.textContent = 'PDF Rendering Error';
                            if (errorDesc) errorDesc.innerHTML = `
                                ${error.message || 'Unknown error occurred'}<br>
                                <span class="text-xs mt-2 block">Error type: ${error.name}</span>
                            `;
                        }
                    }
                }
            }
            
            function setupBatchImageNavigation() {
                if (batchImages.length <= 1) {
                    // Single page - just render it
                    renderPDF(0);
                    return;
                }
                
                // THROTTLED PREFETCH - Don't overwhelm the server! 
                // Load next few pages with delays between requests
                console.log('üî• Starting throttled prefetch of', batchImages.length, 'PDFs...');
                
                // Immediately preload page 1 (most likely next)
                if (batchImages.length > 1) {
                    setTimeout(() => preloadPDF(1), 100);
                }
                
                // Then preload others with 2-second delays
                for (let i = 2; i < batchImages.length; i++) {
                    setTimeout(() => preloadPDF(i), i * 2000);  // Stagger by 2 seconds
                }
                
                const prevBtn = document.getElementById('prevImage');
                const nextBtn = document.getElementById('nextImage');
                const indexDisplay = document.getElementById('currentImageIndex');
                
                async function updateImageDisplay() {
                    if (batchImages[currentImageIndex]) {
                        indexDisplay.textContent = currentImageIndex + 1;
                        
                        console.log('Switching to PDF page:', currentImageIndex);
                        
                        // Render the new PDF page
                        await renderPDF(currentImageIndex);
                        
                        // Update button states
                        prevBtn.disabled = currentImageIndex === 0;
                        nextBtn.disabled = currentImageIndex === batchImages.length - 1;
                    }
                }
                
                prevBtn?.addEventListener('click', () => {
                    if (currentImageIndex > 0) {
                        currentImageIndex--;
                        updateImageDisplay();
                    }
                });
                
                nextBtn?.addEventListener('click', () => {
                    if (currentImageIndex < batchImages.length - 1) {
                        currentImageIndex++;
                        updateImageDisplay();
                    }
                });
                
                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
                        currentImageIndex--;
                        updateImageDisplay();
                    } else if (e.key === 'ArrowRight' && currentImageIndex < batchImages.length - 1) {
                        currentImageIndex++;
                        updateImageDisplay();
                    }
                });
                
                // Initial setup
                updateImageDisplay();
            }
            
            // Initialize batch image navigation
            setupBatchImageNavigation();
            
            // Check if this check is already approved or needs review and initialize the proper state
            const checkStatus = '{{ check.status }}';
            if (checkStatus === 'approved') {
                // Show banner and disable form for already approved checks
                const validatedAt = '{{ check.validated_at }}' || '{{ check.updated_at }}' || '';
                const validatedByName = '{{ check.validated_by_name }}' || '{{ check.validated_by }}' || 'System';
                
                if (validatedAt && validatedAt !== 'None' && validatedAt !== '') {
                    showApprovedBanner(validatedAt, validatedByName);
                } else {
                    // Show banner without timestamp if we don't have validation time
                    showApprovedBanner(new Date().toISOString(), validatedByName);
                }
                disableFormEditing();
            } else if (checkStatus === 'needs_review') {
                // Just disable the needs review button since status is already needs_review
                disableNeedsReviewButton();
            }
            
            const pdfCanvasElement = document.getElementById('pdfCanvas');
            const imageContainer = document.getElementById('imageContainer');
            const imageWrapper = document.getElementById('imageWrapper');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const resetZoomBtn = document.getElementById('resetZoom');
            const toggleGridBtn = document.getElementById('toggleGrid');
            const imageDimensions = document.getElementById('imageDimensions');
            const zoomLevel = document.getElementById('zoomLevel');
            const imageWithCorners = document.querySelector('.image-with-corners');
            
            // Enhanced pan and zoom state - WORKS SAME AS BEFORE!
            let currentZoom = 1.04;  // Default to zoomed-in view (one + click worth)
            let panX = 0;
            let panY = 0;
            let isDragging = false;
            let lastX = 0;
            let lastY = 0;
            let isMouseDown = false;
            let dragThreshold = 1; // Reduced from 3 to 1 for more responsive dragging
            let gridVisible = true;
            
            // Apply initial state immediately - wait for DOM to be fully ready
            setTimeout(() => {
                if (imageWithCorners) {
                    updateZoomLevel();
                    updateTransform();
                    console.log('Initial zoom applied:', currentZoom);
                }
            }, 100);
            
            function updateTransform() {
                if (imageWithCorners) {
                    // Apply transform to the entire image-with-corners container
                    // This ensures corners follow the image exactly
                    imageWithCorners.style.transform = `scale(${currentZoom}) translate(${panX}px, ${panY}px)`;
                }
            }
            
            function updateZoomLevel() {
                if (zoomLevel) {
                    zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
                }
            }
            
            function centerImage() {
                panX = 0;
                panY = 0;
                updateTransform();
            }
            
            function updateImageDimensions() {
                if (pdfCanvasElement && imageDimensions) {
                    imageDimensions.textContent = `${pdfCanvasElement.width} √ó ${pdfCanvasElement.height}px`;
                }
            }
            
            // Zoom function that always centers to image center
            function zoomToCenter(zoomChange) {
                const newZoom = Math.min(Math.max(currentZoom * zoomChange, 0.1), 5);
                
                if (newZoom !== currentZoom) {
                    // Always zoom to the center of the image
                    currentZoom = newZoom;
                    // Reset pan to center when zooming via buttons
                    panX = 0;
                    panY = 0;
                    updateTransform();
                    updateZoomLevel();
                }
            }
            
            // Zoom button controls - always snap to center
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    zoomToCenter(1.3);
                });
            }
            
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    zoomToCenter(0.77);
                });
            }
            
            if (resetZoomBtn) {
                resetZoomBtn.addEventListener('click', () => {
                    currentZoom = 1.04;
                    centerImage();
                    updateZoomLevel();
                });
            }

            // Scroll wheel zoom functionality - zoom in/out with mouse wheel
            if (imageContainer) {
                imageContainer.addEventListener('wheel', (e) => {
                    e.preventDefault(); // Prevent default scrolling
                    
                    // Determine zoom direction (scroll up = zoom in, scroll down = zoom out)
                    const zoomDelta = e.deltaY > 0 ? 0.9 : 1.1; // Smooth zoom increments
                    const newZoom = Math.min(Math.max(currentZoom * zoomDelta, 0.1), 5);
                    
                    if (newZoom !== currentZoom) {
                        currentZoom = newZoom;
                        updateTransform();
                        updateZoomLevel();
                    }
                }, { passive: false });
            }

            // Grid toggle functionality
            if (toggleGridBtn && imageContainer) {
                // Set initial state - grid visible by default
                imageContainer.classList.remove('grid-background-hidden');
                imageContainer.classList.add('grid-background');
                toggleGridBtn.classList.add('bg-blue-100', 'text-blue-700');
                
                toggleGridBtn.addEventListener('click', () => {
                    gridVisible = !gridVisible;
                    if (gridVisible) {
                        // Show grid and corners
                        imageContainer.classList.remove('grid-background-hidden');
                        imageContainer.classList.add('grid-background');
                        toggleGridBtn.classList.add('bg-blue-100', 'text-blue-700');
                        if (imageWithCorners) {
                            imageWithCorners.classList.remove('corners-hidden');
                        }
                    } else {
                        // Hide grid and corners
                        imageContainer.classList.remove('grid-background');
                        imageContainer.classList.add('grid-background-hidden');
                        toggleGridBtn.classList.remove('bg-blue-100', 'text-blue-700');
                        if (imageWithCorners) {
                            imageWithCorners.classList.add('corners-hidden');
                        }
                    }
                });
            }
            
            // Enhanced drag functionality with corner marker interaction
            function startDrag(clientX, clientY) {
                isDragging = false; // Will become true only if mouse moves
                isMouseDown = true;
                lastX = clientX;
                lastY = clientY;
                imageContainer.style.cursor = 'grabbing';
                imageContainer.style.userSelect = 'none';
                
                // Fade corner markers while dragging if grid is visible
                if (imageWithCorners && gridVisible) {
                    imageWithCorners.classList.add('corners-faded');
                }
            }
            
            function updateDrag(clientX, clientY) {
                if (!isMouseDown) return;
                
                const deltaX = clientX - lastX;
                const deltaY = clientY - lastY;
                
                // Only start dragging if mouse has moved a minimum distance
                if (!isDragging && (Math.abs(deltaX) > dragThreshold || Math.abs(deltaY) > dragThreshold)) {
                    isDragging = true;
                }
                
                if (isDragging) {
                    // Scale the movement by zoom level for more natural feel
                    panX += deltaX / currentZoom;
                    panY += deltaY / currentZoom;
                    updateTransform();
                }
                
                lastX = clientX;
                lastY = clientY;
            }
            
            function endDrag() {
                isDragging = false;
                isMouseDown = false;
                imageContainer.style.cursor = 'grab';
                imageContainer.style.userSelect = '';
                
                // Remove fade effect when dragging ends if grid is visible
                if (imageWithCorners && gridVisible) {
                    imageWithCorners.classList.remove('corners-faded');
                }
            }
            
            // Mouse events
            if (imageContainer) {
                imageContainer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startDrag(e.clientX, e.clientY);
                });
                
                document.addEventListener('mousemove', (e) => {
                    updateDrag(e.clientX, e.clientY);
                });
                
                document.addEventListener('mouseup', endDrag);
                
                imageContainer.addEventListener('mouseleave', () => {
                    if (!isDragging) {
                        imageContainer.style.cursor = 'grab';
                    }
                });
                
                imageContainer.addEventListener('mouseenter', () => {
                    if (!isMouseDown) {
                        imageContainer.style.cursor = 'grab';
                    }
                });
            }
            
            // Touch events for mobile support
            if (imageContainer) {
                imageContainer.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        startDrag(touch.clientX, touch.clientY);
                    }
                });
                
                imageContainer.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        updateDrag(touch.clientX, touch.clientY);
                    }
                });
                
                imageContainer.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    endDrag();
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                switch(e.key) {
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomToCenter(1.3);
                        break;
                    case '-':
                        e.preventDefault();
                        zoomToCenter(0.77);
                        break;
                    case '0':
                        e.preventDefault();
                        currentZoom = 1;
                        centerImage();
                        updateZoomLevel();
                        break;
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        currentZoom = 1.04;
                        centerImage();
                        updateZoomLevel();
                        break;
                    case 'g':
                    case 'G':
                        e.preventDefault();
                        toggleGridBtn.click();
                        break;
                }
            });

            // Enhanced field validation status indicators
            function updateFieldStatus() {
                // Get all form fields (inputs and textareas)
                const allFields = document.querySelectorAll('input, textarea');
                
                allFields.forEach(field => {
                    // Skip disabled and readonly fields
                    if (field.disabled || field.readOnly) return;
                    
                    const container = field.closest('.field-container');
                    if (!container) return;
                    
                    const checkIcon = container.querySelector('.fa-check');
                    const warningIcon = container.querySelector('.fa-exclamation-triangle');
                    const isRequired = field.hasAttribute('data-required');
                    
                    // Check if field has a meaningful value (not just placeholder text)
                    const fieldValue = field.value ? field.value.trim() : '';
                    const placeholderValues = ['none', 'null', 'n/a', 'na', '', 'undefined', 'nil'];
                    const hasRealValue = fieldValue !== '' && !placeholderValues.includes(fieldValue.toLowerCase());
                    
                    if (hasRealValue) {
                        // Field has real value - show as complete (green)
                        field.classList.remove('field-incomplete', 'field-error');
                        field.classList.add('field-complete');
                        if (checkIcon) {
                            checkIcon.classList.remove('hidden');
                        }
                        if (warningIcon) {
                            warningIcon.classList.add('hidden');
                        }
                    } else if (isRequired) {
                        // Required field with no real value - show as incomplete (red)
                        field.classList.remove('field-complete', 'field-error');
                        field.classList.add('field-incomplete');
                        if (checkIcon) {
                            checkIcon.classList.add('hidden');
                        }
                        if (warningIcon) {
                            warningIcon.classList.remove('hidden');
                        }
                    } else {
                        // Optional field with no real value - neutral state
                        field.classList.remove('field-complete', 'field-incomplete', 'field-error');
                        if (checkIcon) {
                            checkIcon.classList.add('hidden');
                        }
                        if (warningIcon) {
                            warningIcon.classList.add('hidden');
                        }
                    }
                });
            }

        document.getElementById('quickApprove')?.addEventListener('click', async function() {
            // SAFETY CHECK: Don't proceed if button is disabled
            if (this.disabled) {
                showNotification('Cannot approve: Please fill in all required Salesforce fields (Matter Name, Matter ID, Claimant)', 'warning');
                return;
            }
            
            const formData = new FormData(document.getElementById('checkDetailsForm'));
            const checkId = '{{ check.id }}';
            
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Approving...';
                
                const response = await fetch(`/api/checks/approve/${checkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showApprovedBanner(result.validated_at, result.validated_by_name);
                    showNotification('Check approved! Salesforce protocol initiated.', 'success');
                    disableFormEditing();
                } else {
                    showNotification(result.message || 'Failed to approve check', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="fa-solid fa-check w-4 h-4"></i> Quick Approve';
                }
            } catch (error) {
                console.error('Error approving check:', error);
                showNotification('Error approving check', 'error');
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-check w-4 h-4"></i> Quick Approve';
            }
        });

        document.getElementById('sendToReview')?.addEventListener('click', async function() {
            if (!confirm('Send this check for manual review?')) {
                return;
            }
            
            const formData = new FormData(document.getElementById('checkDetailsForm'));
            const checkId = '{{ check.id }}';
            
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Updating...';
                
                const response = await fetch(`/api/checks/needs-review/${checkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('Check status changed to needs review!', 'warning');
                    updateStatusDisplay('needs_review');
                    disableNeedsReviewButton();
                } else {
                    showNotification(result.message || 'Failed to update check status', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="fa-solid fa-magnifying-glass w-4 h-4"></i> Needs Review';
                }
            } catch (error) {
                console.error('Error updating check status:', error);
                showNotification('Error updating check status', 'error');
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-magnifying-glass w-4 h-4"></i> Needs Review';
            }
        });

        document.getElementById('saveProgress')?.addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('checkDetailsForm'));
            const checkId = '{{ check.id }}';
            
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Saving...';
                
                const response = await fetch(`/api/checks/save/${checkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('Changes saved successfully!', 'success');
                    updateLastSaved(result.updated_at);
                } else {
                    showNotification(result.message || 'Failed to save changes', 'error');
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                showNotification('Error saving changes', 'error');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-save w-4 h-4"></i> Save Progress';
            }
        });

        document.getElementById('undoApproval')?.addEventListener('click', async function() {
            // Prevent double-clicking
            if (this.disabled) {
                return;
            }

            if (!confirm('Are you sure you want to undo this approval?\n\nThis will:\n‚Ä¢ Keep this approved record unchanged (for audit trail)\n‚Ä¢ Create a duplicate in the "Needs Review" queue\n‚Ä¢ Redirect you to the duplicate to make corrections')) {
                return;
            }

            const checkId = '{{ check.id }}';

            try {
                // Immediately disable button to prevent double-clicks
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Creating duplicate...';

                const response = await fetch(`/api/checks/undo-approval/${checkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showNotification('Duplicate created in Needs Review queue! Redirecting...', 'success');

                    // Redirect to the new duplicate check after a brief delay
                    setTimeout(() => {
                        window.location.href = `/checks/detail/${result.duplicate_check_id}`;
                    }, 1500);
                } else {
                    showNotification(result.message || 'Failed to undo approval', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="fa-solid fa-rotate-left w-4 h-4"></i> Undo Approval';
                }
            } catch (error) {
                console.error('Error undoing approval:', error);
                showNotification('Error undoing approval', 'error');
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-rotate-left w-4 h-4"></i> Undo Approval';
            }
        });

        // Three-dot menu toggle - GLOBAL FUNCTION
        window.toggleMoreActionsMenu = function(event) {
            event.stopPropagation();
            event.preventDefault();
            console.log('üî• More actions button clicked!');
            const dropdown = document.getElementById('moreActionsDropdown');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
                console.log('Dropdown toggled. Now:', dropdown.classList.contains('hidden') ? 'hidden' : 'visible');
            }
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('moreActionsDropdown');
            const menuButton = document.getElementById('moreActionsBtn');

            if (dropdown && !dropdown.classList.contains('hidden') &&
                !dropdown.contains(event.target) &&
                !menuButton.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Delete check handler - GLOBAL FUNCTION
        window.deleteCheckHandler = async function() {
            if (!confirm('Are you sure you want to delete this check?\n\nThis action cannot be undone. The check will be permanently removed from the database.')) {
                return;
            }

            const checkId = '{{ check.id }}';
            const deleteBtn = document.getElementById('deleteCheck');

            try {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Deleting...';

                const response = await fetch(`/api/checks/delete/${checkId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showNotification('Check deleted successfully! Redirecting to queue...', 'success');

                    // Redirect to check queue after a brief delay
                    setTimeout(() => {
                        window.location.href = '/checks/queue';
                    }, 1500);
                } else {
                    showNotification(result.message || 'Failed to delete check', 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash w-4 h-4"></i> Delete Check';
                }
            } catch (error) {
                console.error('Error deleting check:', error);
                showNotification('Error deleting check', 'error');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash w-4 h-4"></i> Delete Check';
            }
        };

        function showApprovedBanner(validatedAt, validatedByName) {
            // Remove any existing banner
            const existingBanner = document.getElementById('validationBanner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            const main = document.querySelector('main');
            const banner = document.createElement('div');
            banner.id = 'validationBanner';
            banner.className = 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-r-lg shadow-md';
            banner.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fa-solid fa-check-circle w-5 h-5 mr-3"></i>
                        <div>
                            <strong>‚úì Check Approved!</strong> Salesforce protocol has been initiated.
                            <div class="text-sm mt-1">Validated at ${new Date(validatedAt).toLocaleString()} by ${validatedByName}</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-green-600 hover:text-green-800 transition-colors">
                        <i class="fa-solid fa-times w-4 h-4"></i>
                    </button>
                </div>
            `;
            main.insertBefore(banner, main.firstChild);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showNeedsReviewBanner(flaggedAt, flaggedByName) {
            // Remove any existing banner
            const existingBanner = document.getElementById('validationBanner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            const main = document.querySelector('main');
            const banner = document.createElement('div');
            banner.id = 'validationBanner';
            banner.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-r-lg shadow-md';
            banner.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fa-solid fa-exclamation-triangle w-5 h-5 mr-3"></i>
                        <div>
                            <strong>‚ö† Check Flagged for Review!</strong> This check requires manual verification.
                            <div class="text-sm mt-1">Flagged at ${new Date(flaggedAt).toLocaleString()} by ${flaggedByName}</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-yellow-600 hover:text-yellow-800 transition-colors">
                        <i class="fa-solid fa-times w-4 h-4"></i>
                    </button>
                </div>
            `;
            main.insertBefore(banner, main.firstChild);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function disableFormEditing() {
            document.querySelectorAll('#checkDetailsForm input, #checkDetailsForm textarea').forEach(field => {
                field.disabled = true;
                field.classList.add('bg-gray-100', 'text-gray-600');
            });

            // Disable all action buttons (with null checks)
            const saveBtn = document.getElementById('saveProgress');
            const approveBtn = document.getElementById('quickApprove');
            const undoBtn = document.getElementById('undoApproval');
            const reviewBtn = document.getElementById('sendToReview');

            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.classList.remove('bg-slate-500', 'hover:bg-slate-400');
                saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }

            if (approveBtn) {
                // Hide Quick Approve button when approved
                approveBtn.classList.add('hidden');
            }

            // Show Undo Approval button when approved
            if (undoBtn) {
                undoBtn.classList.remove('hidden');
            }

            if (reviewBtn) {
                // Keep review button disabled when approved
                reviewBtn.disabled = true;
                reviewBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                reviewBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function enableFormEditing() {
            // Re-enable all form fields
            document.querySelectorAll('#checkDetailsForm input, #checkDetailsForm textarea').forEach(field => {
                field.disabled = false;
                field.classList.remove('bg-gray-100', 'text-gray-600');
            });

            // Re-enable action buttons
            const saveBtn = document.getElementById('saveProgress');
            const approveBtn = document.getElementById('quickApprove');
            const undoBtn = document.getElementById('undoApproval');
            const reviewBtn = document.getElementById('sendToReview');

            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                saveBtn.classList.add('bg-slate-500', 'hover:bg-slate-400');
            }

            if (approveBtn) {
                // Show Quick Approve button again
                approveBtn.classList.remove('hidden');
                approveBtn.disabled = false;
                approveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                approveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                approveBtn.innerHTML = '<i class="fa-solid fa-check w-4 h-4"></i> Quick Approve';
            }

            // Hide Undo Approval button
            if (undoBtn) {
                undoBtn.classList.add('hidden');
            }

            if (reviewBtn) {
                reviewBtn.disabled = false;
                reviewBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                reviewBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            }

            // Remove the approved banner
            const existingBanner = document.getElementById('validationBanner');
            if (existingBanner) {
                existingBanner.remove();
            }
        }

        function disableNeedsReviewButton() {
            const needsReviewBtn = document.getElementById('sendToReview');
            if (needsReviewBtn) {
                needsReviewBtn.disabled = true;
                needsReviewBtn.innerHTML = '<i class="fa-solid fa-exclamation-triangle w-4 h-4"></i> Flagged for Review';
                needsReviewBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                needsReviewBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function updateStatusDisplay(newStatus) {
            // Find the status badge and update it
            const statusBadge = document.querySelector('.surface .px-3.py-1.rounded-full');
            if (statusBadge) {
                // Remove old classes
                statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-gray-100', 'text-gray-800', 'bg-orange-100', 'text-orange-800');
                
                // Add new classes based on status
                if (newStatus === 'needs_review') {
                    statusBadge.classList.add('bg-orange-100', 'text-orange-800');
                    statusBadge.textContent = 'Needs Review';
                } else if (newStatus === 'approved') {
                    statusBadge.classList.add('bg-green-100', 'text-green-800');
                    statusBadge.textContent = 'Approved';
                } else if (newStatus === 'pending') {
                    statusBadge.classList.add('bg-yellow-100', 'text-yellow-800');
                    statusBadge.textContent = 'Pending';
                } else {
                    statusBadge.classList.add('bg-gray-100', 'text-gray-800');
                    statusBadge.textContent = newStatus.replace('_', ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                }
            }
        }

        function updateLastSaved(timestamp) {
            let lastSavedEl = document.getElementById('lastSaved');
            if (!lastSavedEl) {
                lastSavedEl = document.createElement('div');
                lastSavedEl.id = 'lastSaved';
                lastSavedEl.className = 'text-xs text-gray-500 mt-2';
                document.querySelector('.surface').appendChild(lastSavedEl);
            }
            lastSavedEl.innerHTML = `<i class="fa-solid fa-clock mr-1"></i>Last saved: ${new Date(timestamp).toLocaleTimeString()}`;
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium shadow-lg transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
            }`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fa-solid fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info'} w-4 h-4 mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        });
    </script>
</body>
</html>
