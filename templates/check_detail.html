<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Detail - {{ check.check_number if check else 'Check Validation' }} - Check Validation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- PDF.js for fast PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* Responsive fluid container - expands elegantly with screen size */
        .container-fluid {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Smart max-widths for different screen sizes */
        @media (min-width: 1536px) {
            .container-fluid {
                max-width: 1800px; /* 2xl screens - generous width */
            }
        }
        
        @media (min-width: 1920px) {
            .container-fluid {
                max-width: 2000px; /* Full HD+ screens */
            }
        }
        
        @media (min-width: 2560px) {
            .container-fluid {
                max-width: 2400px; /* 2K/4K screens - use more space */
            }
        }
        
        /* Grid background pattern */
        .grid-background {
            background-image: 
                linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .grid-background-hidden {
            background-image: none;
        }

        /* Field status indicators */
        .field-status {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        /* Remove the field status icon styles */
        .field-container {
            position: relative;
        }

        .field-complete {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .field-incomplete {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }

        .field-error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        /* ===================================================================== */
        /* FIELD HIGHLIGHTS - Subtle & Professional */
        /* ===================================================================== */
        
        /* Green highlight for extracted data - clean and subtle */
        .field-extracted {
            background: linear-gradient(to right, #ecfdf5 0%, #f0fdf4 100%);
            border-color: #86efac;
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.1);
        }
        
        /* Blue highlight for Salesforce-pulled data - professional and distinct */
        .field-salesforce {
            background: linear-gradient(to right, #eff6ff 0%, #f0f9ff 100%);
            border-color: #93c5fd;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.1);
        }
        
        /* Focus states maintain the highlight colors */
        .field-extracted:focus {
            background: #f0fdf4;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        
        .field-salesforce:focus {
            background: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* ===================================================================== */
        /* SEARCHABLE DROPDOWN - Clean & Professional üîç */
        /* ===================================================================== */
        
        /* Hide the original select element */
        /* üî• MATTER NAME SELECT - Searchable Dropdown Styling */
        select.matter-name-select {
            display: none !important;
        }

        .dropdown-select {
            background-color: #fff;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
            cursor: pointer;
            display: block;
            font-size: 0.875rem;
            height: auto;
            line-height: 1.5rem;
            outline: none;
            padding: 0.5rem 0.75rem;
            padding-right: 2rem;
            position: relative;
            text-align: left !important;
            transition: all 0.2s ease-in-out;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            white-space: nowrap;
            width: 100%;
        }

        .dropdown-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dropdown-select:hover {
            border-color: #9ca3af;
        }

        .dropdown-select:active,
        .dropdown-select.open {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Dropdown arrow */
        .dropdown-select:after {
            height: 0;
            width: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #6b7280;
            -webkit-transform: origin(50% 20%);
            transform: origin(50% 20%);
            transition: all 0.125s ease-in-out;
            content: '';
            display: block;
            margin-top: -2px;
            pointer-events: none;
            position: absolute;
            right: 0.75rem;
            top: 50%;
        }

        .dropdown-select.open:after {
            -webkit-transform: rotate(-180deg);
            transform: rotate(-180deg);
        }

        .dropdown-select.open .list {
            -webkit-transform: translateY(-50%) scale(1);
            transform: translateY(-50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .dropdown-select.open .option {
            cursor: pointer;
        }

        /* Dropdown list container */
        .dropdown-select .list {
            box-sizing: border-box;
            transition: all 0.15s cubic-bezier(0.25, 0, 0.25, 1.75), opacity 0.1s linear;
            -webkit-transform: scale(0.75);
            transform: scale(0.75);
            -webkit-transform-origin: 0% 0;
            transform-origin: 0% 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-color: #fff;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            padding: 0;
            opacity: 0;
            overflow: hidden;
            pointer-events: none;
            position: fixed;
            top: 19.0rem;
            left: 6.5rem;
            transform: translateY(-50%) scale(0.75);
            right: auto;
            width: 990px;
            max-width: 90vw;
            z-index: 9999; /* ABOVE backdrop */
            max-height: 70vh;
            overflow: auto;
            border: 2px solid #3b82f6;
        }

        .dropdown-select .list:hover .option:not(:hover) {
            background-color: transparent !important;
        }

        
        .dropdown-select .dd-search {
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0px;
            height: 60px;   /* CHANGE: Increase from 15px to accommodate input */
            min-height: 60px; /* ADD: Ensure it doesn't shrink */
            background: white;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* ADD: These ensure nothing bleeds through */
            isolation: isolate;  /* Creates new stacking context */
        }

        .dropdown-select .dd-searchbox {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .dropdown-select .dd-searchbox:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Dropdown options */
        .dropdown-select .list ul {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .dropdown-select .option {
            cursor: default;
            font-weight: 400;
            line-height: 1.5rem;
            outline: none;
            padding: 0.5rem 0.75rem;
            text-align: left;
            transition: all 0.2s;
            list-style: none;
            font-size: 0.875rem;
        }

        .dropdown-select .option:hover,
        .dropdown-select .option:focus {
            background-color: #f3f4f6 !important;
        }

        .dropdown-select .option.selected {
            font-weight: 600;
            color: #3b82f6;
            background-color: #eff6ff;
        }

        .dropdown-select .option.selected:focus {
            background: #e0f2fe;
        }

        /* Empty state */
        .dropdown-select .option.no-results {
            color: #9ca3af;
            font-style: italic;
            cursor: default;
        }

        .dropdown-select .option.no-results:hover {
            background-color: transparent !important;
        }

        /* üî• BACKDROP OVERLAY - Dims background when dropdown is open */
        .dropdown-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9990;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: auto;
        }

        .dropdown-backdrop.show {
            display: block;
            opacity: 1;
        }

        /* ===================================================================== */
        /* L-SHAPED CORNER MARKERS - Precisely Aligned to Document Edges */
        /* ===================================================================== */
        
        .image-with-corners {
            position: relative;
            display: inline-block;
        }
        
        .corner-marker {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }
        
        /* L-shaped corner using CSS borders - Top Left */
        /* Positioned with 15px offset to float around the document */
        .corner-top-left {
            top: -20px;
            left: -20px;
            width: 16px;
            height: 16px;
            border-left: 5px solid rgba(0, 0, 0, 0.9);
            border-top: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* L-shaped corner - Top Right */
        .corner-top-right {
            top: -20px;
            right: -20px;
            width: 16px;
            height: 16px;
            border-right: 5px solid rgba(0, 0, 0, 0.9);
            border-top: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* L-shaped corner - Bottom Left */
        .corner-bottom-left {
            bottom: -20px;
            left: -20px;
            width: 16px;
            height: 16px;
            border-left: 5px solid rgba(0, 0, 0, 0.9);
            border-bottom: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* L-shaped corner - Bottom Right */
        .corner-bottom-right {
            bottom: -20px;
            right: -20px;
            width: 16px;
            height: 16px;
            border-right: 5px solid rgba(0, 0, 0, 0.9);
            border-bottom: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* Subtle animation for professional feel */
        @keyframes cornerPulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        .corner-marker:hover {
            animation: cornerPulse 1s ease-in-out;
        }
        
        /* Completely hide corners when grid is off */
        .corners-hidden .corner-marker {
            display: none;
        }
        
        /* Fade corners to light grey when dragging in grid mode */
        .corners-faded .corner-marker {
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="surface-elevated sticky top-0 z-50 backdrop-blur-md bg-white/95">
        <div class="container-fluid px-6 lg:px-8 xl:px-12 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-slate-800 to-slate-700 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-file-invoice-dollar fa-lg text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-primary">Check {{ check.check_number }}</h1>
                        <p class="text-xs text-tertiary font-medium">DETAILED VALIDATION</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    {% if user %}
                    <div class="flex items-center gap-4 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <div class="text-right">
                            <div class="text-sm font-medium text-slate-800">{{ user.name }}</div>
                            <div class="text-xs text-slate-600">{{ user.preferred_username }}</div>
                        </div>
                        <div class="w-8 h-8 bg-slate-600 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-user w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid px-6 lg:px-8 xl:px-12 py-8">
        <div class="surface rounded-xl mb-8 overflow-hidden">
            <!-- Header with Confidence Score -->
            <div class="px-6 py-3 bg-gradient-to-br from-slate-800 to-slate-700 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-base font-semibold text-white">Check Validation Workspace</h2>
                        <p class="text-xs text-white/80">Review image and extracted data side-by-side</p>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm text-white/70">Confidence Score:</span>
                                <span class="text-lg font-bold 
                                    {% if check.confidence_score >= 0.8 %}text-green-400
                                    {% elif check.confidence_score >= 0.6 %}text-yellow-400
                                    {% else %}text-red-400{% endif %}">
                                    {{ check.confidence_percentage }}%
                                </span>
                            </div>
                            <div class="text-xs 
                                {% if check.confidence_score >= 0.8 %}text-green-300
                                {% elif check.confidence_score >= 0.6 %}text-yellow-300
                                {% else %}text-red-300{% endif %}">
                                {% if check.confidence_score >= 0.8 %}
                                    Ready for quick approval
                                {% elif check.confidence_score >= 0.6 %}
                                    Review recommended
                                {% else %}
                                    Manual verification required
                                {% endif %}
                            </div>
                        </div>
                        
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                            {% if check.status == 'pending' %}bg-yellow-100 text-yellow-800
                            {% elif check.status == 'approved' %}bg-green-100 text-green-800
                            {% elif check.status == 'needs_review' %}bg-orange-100 text-orange-800
                            {% elif check.status == 'rejected' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ check.status | replace('_', ' ') | title }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Action Controls Bar -->
            <div class="px-6 py-3 bg-slate-700 border-t border-slate-600">
                <div class="flex items-center justify-between">
                    <!-- Left Side - Navigation & Image Controls -->
                    <div class="flex items-center gap-3">
                        <!-- Back to Queue Button -->
                        <a href="/checks/queue" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 border border-slate-500">
                            <i class="fa-solid fa-arrow-left w-3 h-3"></i>
                            Back to Queue
                        </a>
                        
                        <!-- Divider -->
                        <div class="h-8 w-px bg-slate-500"></div>
                        
                        <!-- Image Controls -->
                        <button id="zoomOut" class="btn-secondary px-3 py-1 text-xs">
                            <i class="fa-solid fa-minus w-3 h-3"></i>
                        </button>
                        <button id="zoomIn" class="btn-secondary px-3 py-1 text-xs">
                            <i class="fa-solid fa-plus w-3 h-3"></i>
                        </button>
                        <button id="resetZoom" class="btn-secondary px-3 py-1 text-xs">
                            <i class="fa-solid fa-expand w-3 h-3 mr-1"></i>
                            Fit
                        </button>
                        <button id="toggleGrid" class="btn-secondary px-3 py-1 text-xs bg-blue-100 text-blue-700">
                            <i class="fa-solid fa-border-all w-3 h-3 mr-1"></i>
                            Grid
                        </button>
                    </div>
                    
                    <!-- Right Side - Validation Actions -->
                    <div class="flex items-center gap-3">
                        <button id="quickApprove" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-check w-4 h-4"></i>
                            Quick Approve
                        </button>
                        <button id="sendToReview" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass w-4 h-4"></i>
                            Needs Review
                        </button>
                        <!-- DISABLED: Save Progress button - needs fixing before re-enabling -->
                        <!-- <button id="saveProgress" class="bg-slate-500 hover:bg-slate-400 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-save w-4 h-4"></i>
                            Save Progress
                        </button> -->
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area - Image Left, Fields Right -->
            <div class="flex flex-col lg:flex-row min-h-[700px] xl:min-h-[800px] 2xl:min-h-[900px]" style="border-top-right-radius: 12px; overflow: hidden;">
                <!-- Left Side - Check Image -->
                <div class="lg:w-1/2 xl:w-[55%] 2xl:w-[58%] bg-gray-50 border-r border-gray-200 flex flex-col">
                    <!-- Image Container -->
                    <div class="flex-1 relative">
                        {% if check.image_data or check.batch_images %}     
                            <!-- Batch Navigation Bar (if multiple images) -->
                            {% if check.batch_images and check.batch_images|length > 1 %}
                            <div class="bg-gray-100 border-b border-gray-200 px-4 py-2">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-600">
                                        <span id="currentImageIndex">1</span> of {{ check.batch_images|length }} images
                                        {% if check.batch_id %}
                                        <span class="ml-2 text-xs text-gray-500">(Batch: {{ check.batch_id }})</span>
                                        {% endif %} 
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="prevImage" class="px-2 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i class="fa-solid fa-chevron-left w-3 h-3"></i>
                                        </button>
                                        <button id="nextImage" class="px-2 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i class="fa-solid fa-chevron-right w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div id="imageContainer" class="h-full overflow-auto bg-gray-50 grid-background-hidden" style="cursor: grab;">
                                <div id="imageWrapper" class="p-4 h-full flex items-center justify-center relative">
                                    <div class="image-with-corners">
                                        <!-- PDF Canvas - Renders PDFs with vector quality -->
                                        <canvas id="pdfCanvas" 
                                            class="border shadow-lg bg-white max-w-full max-h-full"
                                            style="transition: transform 0.1s ease-out;"
                                            data-check-id="{{ check.id }}"
                                            data-current-index="0">
                                        </canvas>
                                        
                                        <!-- Loading indicator -->
                                        <div id="pdfLoading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90">
                                            <div class="text-center">
                                                <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600 mb-2"></i>
                                                <p class="text-sm text-gray-600">Loading PDF...</p>
                                            </div>
                                        </div>
                                        
                                        <!-- L-shaped Corner Markers - Follow Image Transform -->
                                        <div class="corner-marker corner-top-left"></div>
                                        <div class="corner-marker corner-top-right"></div>
                                        <div class="corner-marker corner-bottom-left"></div>
                                        <div class="corner-marker corner-bottom-right"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden error fallback -->
                            <div id="imageError" style="display: none;" class="h-full bg-red-50 border-2 border-dashed border-red-300 flex items-center justify-center">
                                <div class="text-center">
                                    <i class="fa-solid fa-exclamation-triangle w-16 h-16 text-red-400 mb-4"></i>
                                    <h3 class="text-lg font-medium text-red-600 mb-2">PDF Load Error</h3>
                                    <p class="text-sm text-red-500">Unable to display check PDF</p>
                                </div>
                            </div>
                        {% else %}
                            <!-- Placeholder when no image available -->
                            <div class="h-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center">
                                <div class="text-center">
                                    <i class="fa-solid fa-image w-16 h-16 text-gray-400 mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-600 mb-2">No Image Available</h3>
                                    <p class="text-sm text-gray-500">
                                        {% if check.file_name %}
                                            File: {{ check.file_name }}
                                        {% else %}
                                            No image data found
                                        {% endif %}
                                    </p>
                                    {% if check.file_id %}
                                    <p class="text-xs text-gray-400 mt-1">File ID: {{ check.file_id }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Image Info Bar -->
                    <div class="px-4 py-2 bg-gray-100 border-t border-gray-200 flex items-center justify-between text-xs text-gray-600">
                        <div class="flex items-center gap-4">
                            {% if check.file_name %}
                            <span><i class="fa-solid fa-file mr-1"></i>{{ check.file_name }}</span>
                            {% endif %}
                            <!-- <span id="imageDimensions"><i class="fa-solid fa-ruler-combined mr-1"></i></span> -->
                        </div>
                        <div class="flex items-center gap-4">
                            <span><i class="fa-solid fa-mouse-pointer mr-1"></i>Drag to pan</span>
                            <span id="zoomLevel">80%</span>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Check Details Form -->
                <div class="lg:w-1/2 xl:w-[45%] 2xl:w-[42%] bg-white border-l-2 border-gray-300">
                    <div class="p-6 xl:p-8 h-full overflow-y-auto">
                        <form id="checkDetailsForm">
                            <!-- Extracted Fields Grid -->
                            <div class="space-y-3">
                                <!-- Case Information - MOVED TO TOP -->
                                <div class="space-y-3 bg-slate-50 border-2 border-slate-300 p-3 rounded-lg">
                                    <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide border-b-2 border-slate-400 pb-2">
                                        <i class="fa-solid fa-briefcase mr-2 text-slate-700"></i>Case Information
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 gap-3">
                                        <!-- üî• MATTER NAME - NOW THE SEARCHABLE DROPDOWN! -->
                                        <div class="field-container">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                                Matter Name 
                                                <span class="text-blue-600">
                                                    (Searchable) <i class="fa-solid fa-magnifying-glass"></i>
                                                </span>
                                            </label>
                                            <select name="matter_name" data-required="true" class="matter-name-select w-full">
                                                <option value="{{ check.matter_name }}" selected>{{ check.matter_name if check.matter_name else 'Search by matter name...' }}</option>
                                            </select>
                                            <div class="field-status">
                                                <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Matter ID</label>
                                                <input type="text" value="{{ check.matter_id or '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="matter_id" placeholder="Auto-populated from Salesforce" readonly>
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <!-- üî• CLAIMANT - NOW A REGULAR INPUT (auto-populated) -->
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Claimant</label>
                                                <input type="text" value="{{ check.claimant or '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="claimant" data-required="true" placeholder="Auto-populated from Matter" readonly>
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Provider & Claims Information -->
                                <div class="space-y-3 bg-white border border-gray-300 p-3 rounded-lg">
                                    <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide border-b border-gray-200 pb-2">
                                        <i class="fa-solid fa-shield-halved mr-2 text-gray-700"></i>Provider & Claims
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 gap-3">
                                        <div class="field-container">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Provider Name</label>
                                            <input type="text" value="{{ check.provider_name if check.provider_name and check.provider_name != 'None' else '' }}" 
                                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                   name="provider_name" placeholder="Provider name" data-required="true">
                                            <div class="field-status">
                                                <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Claim Number</label>
                                                <input type="text" value="{{ check.claim_number if check.claim_number and check.claim_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="claim_number" placeholder="Claim number">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Policy Number</label>
                                                <input type="text" value="{{ check.policy_number if check.policy_number and check.policy_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="policy_number" placeholder="Policy number">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Amount & Date -->
                                <div class="space-y-3 bg-white border border-gray-300 p-3 rounded-lg">
                                    <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide border-b border-gray-200 pb-2">
                                        <i class="fa-solid fa-dollar-sign mr-2 text-gray-700"></i>Amount & Date
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 gap-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Amount</label>
                                                <input type="text" value="${{ "{:,.2f}".format(check.amount | float) if check.amount else "0.00" }}" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-semibold text-green-700"
                                                       name="amount" data-required="true">  
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Check Type</label>
                                                <input type="text" 
                                                       value="{{ check.check_type or '' }}"
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="check_type">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Check Issue Date</label>
                                                <input type="text" 
                                                       value="{{ check.check_issue_date or '' }}"
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="check_issue_date" data-required="true">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Date of Loss</label>
                                                <input type="text" 
                                                       value="{{ check.date_of_loss or '' }}"
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="date_of_loss" placeholder="Date of loss">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="field-container">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Check Number</label>
                                            <input type="text" value="{{ check.check_number if check.check_number and check.check_number != 'None' else '' }}" 
                                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                   name="check_number" placeholder="Check number" data-required="true">
                                            <div class="field-status">
                                                <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Banking & Additional Information -->
                                <div class="space-y-3 bg-white border border-gray-300 p-3 rounded-lg">
                                    <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide border-b border-gray-200 pb-2">
                                        <i class="fa-solid fa-university mr-2 text-gray-700"></i>Banking & Additional Information
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 gap-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Routing Number</label>
                                                <input type="text" value="{{ check.routing_number if check.routing_number and check.routing_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="routing_number" placeholder="Routing number" data-required="true">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Account Number</label>
                                                <input type="text" value="{{ check.account_number if check.account_number and check.account_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="account_number" placeholder="Account number" data-required="true">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="field-container">
                                            <label class="block text-xs font-medium text-gray-600 mb-1">Memo</label>
                                            <textarea 
                                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                                                   name="memo" rows="2" placeholder="Memo from check">{{ check.memo if check.memo and check.memo != 'None' else '' }}</textarea>
                                            <div class="field-status">
                                                <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                                    <i class="fa-solid fa-truck mr-1"></i>Delivery Service
                                                </label>
                                                <input type="text" value="{{ check.delivery_service if check.delivery_service and check.delivery_service != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                                       name="delivery_service" placeholder="e.g., FedEx, UPS, USPS">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="field-container">
                                                <label class="block text-xs font-medium text-gray-600 mb-1">
                                                    <i class="fa-solid fa-barcode mr-1"></i>Tracking Number
                                                </label>
                                                <input type="text" value="{{ check.tracking_number if check.tracking_number and check.tracking_number != 'None' else '' }}" 
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-mono"
                                                       name="tracking_number" placeholder="Tracking number">
                                                <div class="field-status">
                                                    <i class="fa-solid fa-check w-3 h-3 text-green-600 hidden"></i>
                                                    <i class="fa-solid fa-exclamation-triangle w-3 h-3 text-yellow-600 hidden"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Batch Images Setup
            const batchImages = {{ check.batch_images|tojson if check.batch_images else '[]' }};
            let currentImageIndex = 0;
            
            // ============================================================================
            // SEARCHABLE DROPDOWN SYSTEM - FIRE! üî•üîç
            // ============================================================================
            
            // Global variables for dropdown state
            let allClaimants = [];
            let claimantDropdownCreated = false;
            
            // üî• CREATE THE MATTER NAME DROPDOWN IMMEDIATELY!
            createCustomDropdown();
            
            // ============================================================================
            // SALESFORCE SEARCH - Real-time as you type! üî•
            // ============================================================================
            
            let searchTimeout = null;
            const SEARCH_DELAY = 300; // Wait 300ms after user stops typing
            
            // Fetch claimants list from API (initial load - fallback to Supabase)
            async function loadClaimantsList() {
                try {
                    const response = await fetch('/api/claimants/list');
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        allClaimants = data.claimants || [];
                        console.log(`üî• Loaded ${allClaimants.length} claimant names (${data.source || 'supabase'})!`);
                        
                        // Populate the select element with options
                        const selectElement = document.querySelector('select.claimant-select');
                        if (selectElement) {
                            // Keep the current value option
                            const currentValue = selectElement.value;
                            
                            // Add all claimants as options
                            allClaimants.forEach(claimant => {
                                const option = document.createElement('option');
                                option.value = claimant;
                                option.textContent = claimant;
                                selectElement.appendChild(option);
                            });
                            
                            // Create the custom dropdown UI
                            createCustomDropdown();
                        }
                    }
                } catch (error) {
                    console.error('Error loading claimants:', error);
                }
            }
            
            // =============================================================================
            // üî• SALESFORCE SEARCH - FUTURE-PROOF FOR MATTER NAME SEARCH! 
            // =============================================================================
            // When Jai updates SOQL to search MatterName field, this will automatically work!
            // Current: Searches by claimant name (ClaimentName field in SOQL)
            // Future: Will search by matter name (MatterName field in SOQL) - NO CODE CHANGES NEEDED!
            // =============================================================================
            async function searchSalesforce(query, dropdown, ul) {
                try {
                    // Add loading indicator
                    ul.innerHTML = '<li class="option no-results"><i class="fa-solid fa-spinner fa-spin"></i> Searching Salesforce...</li>';
                    
                    const response = await fetch(`/api/salesforce/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    // üìä CLEAN TABLE VIEW - All Salesforce fields
                    if (data.raw_salesforce_response && data.raw_salesforce_response.length > 0) {
                        console.table(data.raw_salesforce_response);
                    }
                    
                    // Clear the list
                    ul.innerHTML = '';
                    
                    if (data.status === 'success' && data.results && data.results.length > 0) {
                        console.log(`‚úÖ Found ${data.total} matches from ${data.source}!`);
                        
                        // =============================================================================
                        // DISPLAY LOGIC: Show Matter Name as PRIMARY text
                        // Store Claimant and Matter ID as data attributes
                        // =============================================================================
                        data.results.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'option';
                            
                            // Store ALL data for auto-population
                            li.setAttribute('data-value', item.matter_name);  // Matter name is the value!
                            li.setAttribute('data-claimant', item.claimant || '');  // Claimant stored as attribute
                            li.setAttribute('data-matter-id', item.matter_id || '');
                            
                            // =============================================================================
                            // DISPLAY FORMAT: Matter Name (primary) + Claimant (secondary)
                            // User sees: "Ryan Powers | CA | 10/24/25 | Auto (Claimant: Ryan Powers)"
                            // =============================================================================
                            const displayText = item.matter_name 
                                ? `${item.matter_name}` 
                                : item.claimant; // Fallback if no matter name
                            
                            li.textContent = displayText;
                            ul.appendChild(li);
                        });
                        
                        console.log('üìã Results now display Matter Name as primary field!');
                    } else {
                        // No results found
                        const noResults = document.createElement('li');
                        noResults.className = 'option no-results';
                        noResults.innerHTML = `<i class="fa-solid fa-search"></i> No matters found matching "${query}"`;
                        ul.appendChild(noResults);
                    }
                } catch (error) {
                    console.error('Salesforce search failed:', error);
                    
                    // Show error state
                    ul.innerHTML = '';
                    const errorLi = document.createElement('li');
                    errorLi.className = 'option no-results';
                    errorLi.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Search error - try again';
                    ul.appendChild(errorLi);
                }
            }
            
            // Filter local options (when less than 2 chars or as fallback)
            function filterLocalOptions(query, ul) {
                const searchValue = query.toLowerCase().trim();
                let visibleCount = 0;
                
                ul.querySelectorAll('.option:not(.no-results)').forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.indexOf(searchValue) > -1) {
                        option.style.display = '';
                        visibleCount++;
                    } else {
                        option.style.display = 'none';
                    }
                });
                
                // Show/hide "no results" message
                let noResultsLi = ul.querySelector('.option.no-results');
                if (visibleCount === 0 && searchValue.length > 0) {
                    if (!noResultsLi) {
                        noResultsLi = document.createElement('li');
                        noResultsLi.className = 'option no-results';
                        ul.appendChild(noResultsLi);
                    }
                    noResultsLi.textContent = 'No matching claimants found';
                    noResultsLi.style.display = '';
                } else if (noResultsLi) {
                    noResultsLi.style.display = 'none';
                }
            }
            
            // Create custom searchable dropdown for MATTER NAME
            function createCustomDropdown() {
                const selectElement = document.querySelector('select.matter-name-select');
                if (!selectElement || claimantDropdownCreated) return;

                claimantDropdownCreated = true;

                // üî• CREATE BACKDROP OVERLAY
                const backdrop = document.createElement('div');
                backdrop.className = 'dropdown-backdrop';
                backdrop.id = 'dropdownBackdrop';
                document.body.appendChild(backdrop);

                // Create dropdown container
                const dropdown = document.createElement('div');
                dropdown.className = 'dropdown-select wide';
                dropdown.setAttribute('tabindex', '0');
                
                // Current value display - MATTER NAME DROPDOWN! üî•
                const current = document.createElement('span');
                current.className = 'current';
                const selectedOption = selectElement.querySelector('option:checked') || selectElement.querySelector('option');
                current.textContent = selectedOption ? selectedOption.textContent : 'Search by matter name...';
                dropdown.appendChild(current);
                
                // List container
                const listDiv = document.createElement('div');
                listDiv.className = 'list';
                
                // Search box - MATTER NAME SEARCH! üî•
                const searchDiv = document.createElement('div');
                searchDiv.className = 'dd-search';
                const searchInput = document.createElement('input');
                searchInput.id = 'matterNameSearchBox';
                searchInput.className = 'dd-searchbox';
                searchInput.type = 'text';
                searchInput.placeholder = 'Search matter names...';
                searchInput.autocomplete = 'off';
                searchDiv.appendChild(searchInput);
                listDiv.appendChild(searchDiv);
                
                // Options list
                const ul = document.createElement('ul');
                const options = selectElement.querySelectorAll('option');
                options.forEach((option, index) => {
                    const li = document.createElement('li');
                    li.className = 'option' + (option.selected ? ' selected' : '');
                    li.setAttribute('data-value', option.value);
                    li.textContent = option.textContent;
                    ul.appendChild(li);
                });
                listDiv.appendChild(ul);
                dropdown.appendChild(listDiv);
                
                // Insert after select element
                selectElement.parentNode.insertBefore(dropdown, selectElement.nextSibling);
                
                console.log('‚úÖ Searchable dropdown created!');
                
                // Setup event handlers
                setupDropdownEvents(dropdown, selectElement, searchInput, ul);
            }
            
            // Setup all dropdown event handlers
            function setupDropdownEvents(dropdown, selectElement, searchInput, ul) {
                const backdrop = document.getElementById('dropdownBackdrop');

                // Function to position dropdown relative to left panel
                const positionDropdown = () => {
                    const leftPanel = document.querySelector('.bg-gray-50.border-r.flex.flex-col');
                    const listElement = dropdown.querySelector('.list');
                    if (leftPanel && listElement && dropdown.classList.contains('open')) {
                        const rect = leftPanel.getBoundingClientRect();
                        listElement.style.width = rect.width + 'px';
                        listElement.style.left = rect.left + 'px';
                    }
                };

                // Close dropdown helper
                const closeDropdown = () => {
                    dropdown.classList.remove('open');
                    backdrop.classList.remove('show');
                    ul.querySelectorAll('.option').forEach(opt => opt.removeAttribute('tabindex'));
                    document.body.style.overflow = ''; // Re-enable scrolling
                };

                // Toggle dropdown open/close
                dropdown.addEventListener('click', function(event) {
                    if (event.target.matches('.dd-searchbox')) {
                        return; // Don't close when clicking search box
                    }

                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-select').forEach(dd => {
                        if (dd !== dropdown) dd.classList.remove('open');
                    });

                    dropdown.classList.toggle('open');

                    if (dropdown.classList.contains('open')) {
                        // üî• POSITION DROPDOWN - Match left panel width dynamically
                        positionDropdown();

                        // üî• SHOW BACKDROP and disable body scroll
                        console.log('Adding backdrop show class', backdrop);
                        backdrop.classList.add('show');
                        console.log('Backdrop classes:', backdrop.className);
                        document.body.style.overflow = 'hidden';

                        ul.querySelectorAll('.option').forEach(opt => opt.setAttribute('tabindex', '0'));
                        const selected = ul.querySelector('.option.selected');
                        if (selected) selected.focus();
                        // Focus search box when opening
                        setTimeout(() => searchInput.focus(), 50);
                    } else {
                        closeDropdown();
                    }
                });

                // Close dropdown when clicking backdrop
                backdrop.addEventListener('click', closeDropdown);

                // Close dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!dropdown.contains(event.target) && !event.target.matches('.dropdown-backdrop')) {
                        closeDropdown();
                    }
                });

                // üî• REPOSITION DROPDOWN ON WINDOW RESIZE
                window.addEventListener('resize', positionDropdown);
                
                // DEBOUNCED SALESFORCE SEARCH - searches as user types!
                searchInput.addEventListener('keyup', function() {
                    const searchValue = this.value.trim();
                    
                    // Clear previous timeout
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    
                    // If empty or less than 2 chars, just filter local options
                    if (searchValue.length < 2) {
                        filterLocalOptions(searchValue, ul);
                        return;
                    }
                    
                    // Wait for user to stop typing, THEN search Salesforce
                    searchTimeout = setTimeout(async () => {
                        await searchSalesforce(searchValue, dropdown, ul);
                    }, SEARCH_DELAY);
                });
                
                // Option selection - AUTO-POPULATE FIELDS FROM STORED DATA! üî•
                ul.addEventListener('click', async function(event) {
                    if (event.target.matches('.option') && !event.target.matches('.no-results')) {
                        // Update selected state
                        ul.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                        event.target.classList.add('selected');
                        
                        // Update display
                        dropdown.querySelector('.current').textContent = event.target.textContent;
                        
                        // Update actual select value
                        selectElement.value = event.target.getAttribute('data-value');
                        
                        // Trigger change event for validation
                        selectElement.dispatchEvent(new Event('change', { bubbles: true }));
                        selectElement.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        // Close dropdown
                        dropdown.classList.remove('open');
                        dropdown.focus();
                        
                        const matterName = event.target.textContent;
                        const claimantName = event.target.getAttribute('data-claimant');
                        const matterId = event.target.getAttribute('data-matter-id');
                        
                        // =============================================================================
                        // AUTO-POPULATE ALL 3 FIELDS - Data already loaded! üöÄ
                        // =============================================================================
                        
                        // 1. Matter Name (update the hidden select properly!)
                        const matterNameInput = document.querySelector('select[name="matter_name"]');
                        if (matterNameInput) {
                            // IMPORTANT: We need to create/update an option with this value
                            // because select elements can only have values that match their options
                            let existingOption = Array.from(matterNameInput.options).find(opt => opt.value === matterName);
                            
                            if (!existingOption) {
                                // Create new option if it doesn't exist
                                const newOption = document.createElement('option');
                                newOption.value = matterName;
                                newOption.textContent = matterName;
                                newOption.selected = true;
                                matterNameInput.appendChild(newOption);
                            } else {
                                // Select existing option
                                existingOption.selected = true;
                            }
                            
                            // Now set the value
                            matterNameInput.value = matterName;
                            matterNameInput.dispatchEvent(new Event('change', { bubbles: true }));
                            matterNameInput.dispatchEvent(new Event('input', { bubbles: true }));
                            matterNameInput.classList.add('field-salesforce');
                        }
                        
                        // 2. Claimant
                        if (claimantName) {
                            const claimantInput = document.querySelector('input[name="claimant"]');
                            if (claimantInput) {
                                claimantInput.value = claimantName;
                                claimantInput.dispatchEvent(new Event('change', { bubbles: true }));
                                claimantInput.dispatchEvent(new Event('input', { bubbles: true }));
                                claimantInput.classList.add('field-salesforce');
                            }
                        }
                        
                        // 3. Matter ID
                        if (matterId) {
                            const matterIdInput = document.querySelector('input[name="matter_id"]');
                            if (matterIdInput) {
                                matterIdInput.value = matterId;
                                matterIdInput.dispatchEvent(new Event('change', { bubbles: true }));
                                matterIdInput.dispatchEvent(new Event('input', { bubbles: true }));
                                matterIdInput.classList.add('field-salesforce');
                            }
                        }
                        
                        // Validate after auto-population
                        setTimeout(validateQuickApprove, 0);
                    }
                });
                
                // Keyboard navigation
                dropdown.addEventListener('keydown', function(event) {
                    const focused = ul.querySelector('.option:focus') || ul.querySelector('.option.selected');
                    
                    if (event.keyCode == 13) { // Enter
                        if (dropdown.classList.contains('open')) {
                            if (focused && !focused.matches('.no-results')) {
                                focused.click();
                            }
                        } else {
                            dropdown.click();
                        }
                        event.preventDefault();
                    } else if (event.keyCode == 40) { // Down arrow
                        if (!dropdown.classList.contains('open')) {
                            dropdown.click();
                        } else if (focused) {
                            let next = focused.nextElementSibling;
                            while (next && next.style.display === 'none') {
                                next = next.nextElementSibling;
                            }
                            if (next) next.focus();
                        }
                        event.preventDefault();
                    } else if (event.keyCode == 38) { // Up arrow
                        if (!dropdown.classList.contains('open')) {
                            dropdown.click();
                        } else if (focused) {
                            let prev = focused.previousElementSibling;
                            while (prev && prev.style.display === 'none') {
                                prev = prev.previousElementSibling;
                            }
                            if (prev) prev.focus();
                        }
                        event.preventDefault();
                    } else if (event.keyCode == 27) { // Escape
                        if (dropdown.classList.contains('open')) {
                            dropdown.click();
                        }
                        event.preventDefault();
                    }
                });
            }
            
            // Initialize dropdown on page load
            loadClaimantsList();
            
            // ============================================================================
            // FIELD HIGHLIGHTING - Clean & Professional üé®
            // ============================================================================
            function applyFieldHighlights() {
                // Helper function to check if field has real data
                function hasRealData(value) {
                    if (!value) return false;
                    const trimmed = value.trim();
                    if (trimmed === '') return false;
                    if (trimmed.toLowerCase() === 'none') return false;
                    if (trimmed.toLowerCase() === 'null') return false;
                    if (trimmed === '0' || trimmed === '0.00' || trimmed === '$0.00') return false;
                    return true;
                }
                
                // Salesforce-pulled fields (blue highlight) - top 3 fields
                const salesforceFields = ['matter_name', 'matter_id', 'claimant'];
                
                // All other extracted fields (green highlight)
                const extractedFields = [
                    'pay_to', 'amount', 'check_issue_date', 'date_of_loss',
                    'check_number', 'routing_number', 'account_number', 'memo',
                    'provider_name', 'claim_number', 'policy_number', 'check_type',
                    'case_type', 'delivery_service', 'insurance_company',
                    'reference_number', 'bank_name', 'insured_name', 'extraction_notes'
                ];
                
                // Apply blue highlights to Salesforce fields if they have REAL data
                salesforceFields.forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field && hasRealData(field.value)) {
                        field.classList.add('field-salesforce');
                    }
                });
                
                // Apply green highlights to extracted fields if they have REAL data
                extractedFields.forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field && hasRealData(field.value)) {
                        field.classList.add('field-extracted');
                    }
                });
            }
            
            // Apply highlights on page load
            applyFieldHighlights();
            
            // ============================================================================
            // QUICK APPROVE VALIDATION - Require Salesforce fields üîí
            // ============================================================================
            function validateQuickApprove() {
                // Helper function to check if field has real data (same as highlights)
                function hasRealData(value) {
                    if (!value) return false;
                    const trimmed = value.trim();
                    if (trimmed === '') return false;
                    if (trimmed.toLowerCase() === 'none') return false;
                    if (trimmed.toLowerCase() === 'null') return false;
                    if (trimmed === '0' || trimmed === '0.00' || trimmed === '$0.00') return false;
                    return true;
                }
                
                // Get the three required Salesforce fields
                const matterNameField = document.querySelector('[name="matter_name"]');
                const matterIdField = document.querySelector('[name="matter_id"]');
                const claimantField = document.querySelector('[name="claimant"]');
                const quickApproveBtn = document.getElementById('quickApprove');
                
                if (!quickApproveBtn) return;
                
                // Check if all three have real data
                const matterNameValid = matterNameField && hasRealData(matterNameField.value);
                const matterIdValid = matterIdField && hasRealData(matterIdField.value);
                const claimantValid = claimantField && hasRealData(claimantField.value);
                const allFieldsValid = matterNameValid && matterIdValid && claimantValid;
                
                if (allFieldsValid) {
                    // Enable Quick Approve
                    quickApproveBtn.disabled = false;
                    quickApproveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    quickApproveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    quickApproveBtn.title = 'All required Salesforce fields populated - ready to approve';
                } else {
                    // Disable Quick Approve
                    quickApproveBtn.disabled = true;
                    quickApproveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    quickApproveBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    
                    const missingFields = [];
                    if (!matterNameValid) missingFields.push('Matter Name');
                    if (!matterIdValid) missingFields.push('Matter ID');
                    if (!claimantValid) missingFields.push('Claimant');
                    
                    quickApproveBtn.title = `Cannot approve: Missing Salesforce data (${missingFields.join(', ')})`;
                }
            }
            
            // Run validation on page load
            validateQuickApprove();
            
            // Re-validate when any of the required fields change
            // Use setTimeout to defer validation until after auto-population completes
            ['matter_name', 'matter_id', 'claimant'].forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    field.addEventListener('input', () => setTimeout(validateQuickApprove, 0));
                    field.addEventListener('change', () => setTimeout(validateQuickApprove, 0));
                }
            });
            
            // ============================================================================
            // PDF.js RENDERING SYSTEM - BLAZING FAST! üî•
            // ============================================================================
            const pdfCanvas = document.getElementById('pdfCanvas');
            const pdfLoading = document.getElementById('pdfLoading');
            const pdfError = document.getElementById('imageError');
            let currentPdfDoc = null;
            let currentPdfPage = null;
            
            // PRELOADING CACHE - Load next/prev PDFs in background! üöÄ
            const pdfCache = new Map();
            let preloadAbortController = null;
            
            // Update form fields with extracted data - GLOBAL FUNCTION
            function updateFormWithExtractedData(extractedData) {
                const fieldMappings = {
                    'claimant': extractedData.claimant,
                    'pay_to': extractedData.pay_to,
                    'amount': extractedData.amount,
                    'check_issue_date': extractedData.check_issue_date,
                    'date_of_loss': extractedData.date_of_loss,
                    'check_number': extractedData.check_number,
                    'routing_number': extractedData.routing_number,
                    'account_number': extractedData.account_number,
                    'memo': extractedData.memo,
                    'provider_name': extractedData.provider_name || extractedData.insurance_company,
                    'claim_number': extractedData.claim_number,
                    'policy_number': extractedData.policy_number
                };
                
                Object.entries(fieldMappings).forEach(([fieldName, value]) => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // PRELOAD PDFs in background - NO MORE WAITING! üî•
            async function preloadPDF(pageIndex) {
                if (!batchImages || pageIndex < 0 || pageIndex >= batchImages.length) return;
                
                const checkId = '{{ check.id }}';
                const pdfUrl = `/checks/pdf/${checkId}/${pageIndex}`;
                
                // Skip if already cached
                if (pdfCache.has(pdfUrl)) {
                    console.log('PDF already cached:', pageIndex);
                    return;
                }
                
                console.log('üîÑ Preloading PDF in background:', pageIndex);
                
                try {
                    const loadingTask = pdfjsLib.getDocument({
                        url: pdfUrl,
                        cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                        cMapPacked: true,
                        disableAutoFetch: true,
                        disableStream: false,
                        useSystemFonts: true
                    });
                    
                    const pdfDoc = await loadingTask.promise;
                    const pdfPage = await pdfDoc.getPage(1);
                    
                    // Cache the loaded PDF doc and page
                    pdfCache.set(pdfUrl, { doc: pdfDoc, page: pdfPage });
                    console.log('‚úÖ PDF cached:', pageIndex);
                } catch (error) {
                    // Preload failures are not critical - just log and continue
                    console.warn(`‚ö†Ô∏è Preload failed for page ${pageIndex}:`, error.message || error);
                    // Don't show error to user - they'll see it if they navigate to that page
                }
            }
            
            // Preload adjacent pages when user views a page
            function preloadAdjacentPages(currentIndex) {
                // Cancel any in-progress preload
                if (preloadAbortController) {
                    preloadAbortController.abort();
                }
                preloadAbortController = new AbortController();
                
                // Preload next page (most likely to be viewed)
                if (currentIndex + 1 < batchImages.length) {
                    preloadPDF(currentIndex + 1);
                }
                
                // Preload previous page (might go back)
                if (currentIndex - 1 >= 0) {
                    preloadPDF(currentIndex - 1);
                }
                
                // Preload 2 pages ahead for fast users
                if (currentIndex + 2 < batchImages.length) {
                    setTimeout(() => preloadPDF(currentIndex + 2), 500);
                }
            }
            
            // PDF Rendering function - NOW WITH INSTANT CACHE! ‚ö°
            async function renderPDF(pageIndex = 0) {
                if (!batchImages || batchImages.length === 0) {
                    console.warn('No PDF pages available');
                    if (pdfLoading) pdfLoading.style.display = 'none';
                    if (pdfError) pdfError.style.display = 'flex';
                    return;
                }
                
                try {
                    const startTime = performance.now();
                    
                    // Show loading indicator
                    if (pdfLoading) pdfLoading.style.display = 'flex';
                    if (pdfError) pdfError.style.display = 'none';
                    
                    const currentImg = batchImages[pageIndex];
                    const checkId = '{{ check.id }}';
                    const pdfUrl = `/checks/pdf/${checkId}/${pageIndex}`;
                    
                    // CHECK CACHE FIRST! üöÄ
                    let pdfDoc, pdfPage;
                    if (pdfCache.has(pdfUrl)) {
                        console.log('üí® INSTANT LOAD from cache!', pageIndex);
                        const cached = pdfCache.get(pdfUrl);
                        pdfDoc = cached.doc;
                        pdfPage = cached.page;
                    } else {
                        // Not cached - load it now
                        console.log('Loading PDF:', pdfUrl);
                        
                        const loadingTask = pdfjsLib.getDocument({
                            url: pdfUrl,
                            cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                            cMapPacked: true,
                            disableAutoFetch: true,
                            disableStream: false,
                            disableFontFace: false,
                            useSystemFonts: true
                        });
                        
                        pdfDoc = await loadingTask.promise;
                        pdfPage = await pdfDoc.getPage(1);
                        
                        // Cache it for next time
                        pdfCache.set(pdfUrl, { doc: pdfDoc, page: pdfPage });
                        
                        console.log('PDF loaded in', Math.round(performance.now() - startTime), 'ms');
                    }
                    
                    currentPdfDoc = pdfDoc;
                    currentPdfPage = pdfPage;
                    
                    // MAXIMUM CLARITY: Use 2.0x scale for sharpest rendering!
                    // This is retina-quality - super crisp text
                    const viewport = pdfPage.getViewport({ scale: 2.0 });
                    
                    // Set canvas dimensions
                    pdfCanvas.width = viewport.width;
                    pdfCanvas.height = viewport.height;
                    pdfCanvas.style.width = (viewport.width / 2.0) + 'px';
                    pdfCanvas.style.height = (viewport.height / 2.0) + 'px';
                    
                    // Render PDF page to canvas with optimized settings
                    const context = pdfCanvas.getContext('2d', {
                        alpha: false,
                        desynchronized: true
                    });
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport,
                        intent: 'display',
                        renderInteractiveForms: false,
                        enableWebGL: true
                    };
                    
                    await pdfPage.render(renderContext).promise;
                    
                    const totalTime = Math.round(performance.now() - startTime);
                    console.log('PDF rendered in', totalTime, 'ms TOTAL');
                    
                    // Hide loading
                    if (pdfLoading) pdfLoading.style.display = 'none';
                    
                    // Update form with extracted data if available
                    if (currentImg.extracted_data) {
                        updateFormWithExtractedData(currentImg.extracted_data);
                    }
                    
                    // PRELOAD ADJACENT PAGES IN BACKGROUND! üöÄ
                    preloadAdjacentPages(pageIndex);
                    
                } catch (error) {
                    console.error('‚ùå PDF rendering error:', error);
                    console.error('Error type:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Stack trace:', error.stack);
                    
                    // Hide loading
                    if (pdfLoading) pdfLoading.style.display = 'none';
                    
                    // Show detailed error to user
                    if (pdfError) {
                        pdfError.style.display = 'flex';
                        
                        // Update error message with details
                        const errorTitle = pdfError.querySelector('h3');
                        const errorDesc = pdfError.querySelector('p');
                        
                        if (error.name === 'UnexpectedResponseException') {
                            if (errorTitle) errorTitle.textContent = 'PDF Loading Failed';
                            if (errorDesc) errorDesc.innerHTML = `
                                <strong>Server Error (500)</strong><br>
                                The server encountered an error loading this PDF.<br>
                                <span class="text-xs">Check: ${checkId}, Page: ${pageIndex}</span>
                            `;
                        } else if (error.message && error.message.includes('404')) {
                            if (errorTitle) errorTitle.textContent = 'PDF Not Found';
                            if (errorDesc) errorDesc.textContent = 'This PDF file could not be found in storage.';
                        } else if (error.message && error.message.includes('NetworkError')) {
                            if (errorTitle) errorTitle.textContent = 'Network Error';
                            if (errorDesc) errorDesc.textContent = 'Could not connect to server. Check your internet connection.';
                        } else {
                            if (errorTitle) errorTitle.textContent = 'PDF Rendering Error';
                            if (errorDesc) errorDesc.innerHTML = `
                                ${error.message || 'Unknown error occurred'}<br>
                                <span class="text-xs mt-2 block">Error type: ${error.name}</span>
                            `;
                        }
                    }
                }
            }
            
            function setupBatchImageNavigation() {
                if (batchImages.length <= 1) {
                    // Single page - just render it
                    renderPDF(0);
                    return;
                }
                
                // THROTTLED PREFETCH - Don't overwhelm the server! 
                // Load next few pages with delays between requests
                console.log('üî• Starting throttled prefetch of', batchImages.length, 'PDFs...');
                
                // Immediately preload page 1 (most likely next)
                if (batchImages.length > 1) {
                    setTimeout(() => preloadPDF(1), 100);
                }
                
                // Then preload others with 2-second delays
                for (let i = 2; i < batchImages.length; i++) {
                    setTimeout(() => preloadPDF(i), i * 2000);  // Stagger by 2 seconds
                }
                
                const prevBtn = document.getElementById('prevImage');
                const nextBtn = document.getElementById('nextImage');
                const indexDisplay = document.getElementById('currentImageIndex');
                
                async function updateImageDisplay() {
                    if (batchImages[currentImageIndex]) {
                        indexDisplay.textContent = currentImageIndex + 1;
                        
                        console.log('Switching to PDF page:', currentImageIndex);
                        
                        // Render the new PDF page
                        await renderPDF(currentImageIndex);
                        
                        // Update button states
                        prevBtn.disabled = currentImageIndex === 0;
                        nextBtn.disabled = currentImageIndex === batchImages.length - 1;
                    }
                }
                
                prevBtn?.addEventListener('click', () => {
                    if (currentImageIndex > 0) {
                        currentImageIndex--;
                        updateImageDisplay();
                    }
                });
                
                nextBtn?.addEventListener('click', () => {
                    if (currentImageIndex < batchImages.length - 1) {
                        currentImageIndex++;
                        updateImageDisplay();
                    }
                });
                
                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
                        currentImageIndex--;
                        updateImageDisplay();
                    } else if (e.key === 'ArrowRight' && currentImageIndex < batchImages.length - 1) {
                        currentImageIndex++;
                        updateImageDisplay();
                    }
                });
                
                // Initial setup
                updateImageDisplay();
            }
            
            // Initialize batch image navigation
            setupBatchImageNavigation();
            
            // Check if this check is already approved or needs review and initialize the proper state
            const checkStatus = '{{ check.status }}';
            if (checkStatus === 'approved') {
                // Show banner and disable form for already approved checks
                const validatedAt = '{{ check.validated_at }}' || '{{ check.updated_at }}' || '';
                const validatedByName = '{{ check.validated_by_name }}' || '{{ check.validated_by }}' || 'System';
                
                if (validatedAt && validatedAt !== 'None' && validatedAt !== '') {
                    showApprovedBanner(validatedAt, validatedByName);
                } else {
                    // Show banner without timestamp if we don't have validation time
                    showApprovedBanner(new Date().toISOString(), validatedByName);
                }
                disableFormEditing();
            } else if (checkStatus === 'needs_review') {
                // Just disable the needs review button since status is already needs_review
                disableNeedsReviewButton();
            }
            
            const pdfCanvasElement = document.getElementById('pdfCanvas');
            const imageContainer = document.getElementById('imageContainer');
            const imageWrapper = document.getElementById('imageWrapper');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const resetZoomBtn = document.getElementById('resetZoom');
            const toggleGridBtn = document.getElementById('toggleGrid');
            const imageDimensions = document.getElementById('imageDimensions');
            const zoomLevel = document.getElementById('zoomLevel');
            const imageWithCorners = document.querySelector('.image-with-corners');
            
            // Enhanced pan and zoom state - WORKS SAME AS BEFORE!
            let currentZoom = 1.04;  // Default to zoomed-in view (one + click worth)
            let panX = 0;
            let panY = 0;
            let isDragging = false;
            let lastX = 0;
            let lastY = 0;
            let isMouseDown = false; 
            let dragThreshold = 3;
            let gridVisible = true;
            
            // Apply initial state immediately - wait for DOM to be fully ready
            setTimeout(() => {
                if (imageWithCorners) {
                    updateZoomLevel();
                    updateTransform();
                    console.log('Initial zoom applied:', currentZoom);
                }
            }, 100);
            
            function updateTransform() {
                if (imageWithCorners) {
                    // Apply transform to the entire image-with-corners container
                    // This ensures corners follow the image exactly
                    imageWithCorners.style.transform = `scale(${currentZoom}) translate(${panX}px, ${panY}px)`;
                }
            }
            
            function updateZoomLevel() {
                if (zoomLevel) {
                    zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
                }
            }
            
            function centerImage() {
                panX = 0;
                panY = 0;
                updateTransform();
            }
            
            function updateImageDimensions() {
                if (pdfCanvasElement && imageDimensions) {
                    imageDimensions.textContent = `${pdfCanvasElement.width} √ó ${pdfCanvasElement.height}px`;
                }
            }
            
            // Zoom function that always centers to image center
            function zoomToCenter(zoomChange) {
                const newZoom = Math.min(Math.max(currentZoom * zoomChange, 0.1), 5);
                
                if (newZoom !== currentZoom) {
                    // Always zoom to the center of the image
                    currentZoom = newZoom;
                    // Reset pan to center when zooming via buttons
                    panX = 0;
                    panY = 0;
                    updateTransform();
                    updateZoomLevel();
                }
            }
            
            // Zoom button controls - always snap to center
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    zoomToCenter(1.3);
                });
            }
            
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    zoomToCenter(0.77);
                });
            }
            
            if (resetZoomBtn) {
                resetZoomBtn.addEventListener('click', () => {
                    currentZoom = 1.04;
                    centerImage();
                    updateZoomLevel();
                });
            }

            // Scroll wheel zoom functionality - zoom in/out with mouse wheel
            if (imageContainer) {
                imageContainer.addEventListener('wheel', (e) => {
                    e.preventDefault(); // Prevent default scrolling
                    
                    // Determine zoom direction (scroll up = zoom in, scroll down = zoom out)
                    const zoomDelta = e.deltaY > 0 ? 0.9 : 1.1; // Smooth zoom increments
                    const newZoom = Math.min(Math.max(currentZoom * zoomDelta, 0.1), 5);
                    
                    if (newZoom !== currentZoom) {
                        currentZoom = newZoom;
                        updateTransform();
                        updateZoomLevel();
                    }
                }, { passive: false });
            }

            // Grid toggle functionality
            if (toggleGridBtn && imageContainer) {
                // Set initial state - grid visible by default
                imageContainer.classList.remove('grid-background-hidden');
                imageContainer.classList.add('grid-background');
                toggleGridBtn.classList.add('bg-blue-100', 'text-blue-700');
                
                toggleGridBtn.addEventListener('click', () => {
                    gridVisible = !gridVisible;
                    if (gridVisible) {
                        // Show grid and corners
                        imageContainer.classList.remove('grid-background-hidden');
                        imageContainer.classList.add('grid-background');
                        toggleGridBtn.classList.add('bg-blue-100', 'text-blue-700');
                        if (imageWithCorners) {
                            imageWithCorners.classList.remove('corners-hidden');
                        }
                    } else {
                        // Hide grid and corners
                        imageContainer.classList.remove('grid-background');
                        imageContainer.classList.add('grid-background-hidden');
                        toggleGridBtn.classList.remove('bg-blue-100', 'text-blue-700');
                        if (imageWithCorners) {
                            imageWithCorners.classList.add('corners-hidden');
                        }
                    }
                });
            }
            
            // Enhanced drag functionality with corner marker interaction
            function startDrag(clientX, clientY) {
                isDragging = false; // Will become true only if mouse moves
                isMouseDown = true;
                lastX = clientX;
                lastY = clientY;
                imageContainer.style.cursor = 'grabbing';
                imageContainer.style.userSelect = 'none';
                
                // Fade corner markers while dragging if grid is visible
                if (imageWithCorners && gridVisible) {
                    imageWithCorners.classList.add('corners-faded');
                }
            }
            
            function updateDrag(clientX, clientY) {
                if (!isMouseDown) return;
                
                const deltaX = clientX - lastX;
                const deltaY = clientY - lastY;
                
                // Only start dragging if mouse has moved a minimum distance
                if (!isDragging && (Math.abs(deltaX) > dragThreshold || Math.abs(deltaY) > dragThreshold)) {
                    isDragging = true;
                }
                
                if (isDragging) {
                    // Scale the movement by zoom level for more natural feel
                    panX += deltaX / currentZoom;
                    panY += deltaY / currentZoom;
                    updateTransform();
                }
                
                lastX = clientX;
                lastY = clientY;
            }
            
            function endDrag() {
                isDragging = false;
                isMouseDown = false;
                imageContainer.style.cursor = 'grab';
                imageContainer.style.userSelect = '';
                
                // Remove fade effect when dragging ends if grid is visible
                if (imageWithCorners && gridVisible) {
                    imageWithCorners.classList.remove('corners-faded');
                }
            }
            
            // Mouse events
            if (imageContainer) {
                imageContainer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startDrag(e.clientX, e.clientY);
                });
                
                document.addEventListener('mousemove', (e) => {
                    updateDrag(e.clientX, e.clientY);
                });
                
                document.addEventListener('mouseup', endDrag);
                
                imageContainer.addEventListener('mouseleave', () => {
                    if (!isDragging) {
                        imageContainer.style.cursor = 'grab';
                    }
                });
                
                imageContainer.addEventListener('mouseenter', () => {
                    if (!isMouseDown) {
                        imageContainer.style.cursor = 'grab';
                    }
                });
            }
            
            // Touch events for mobile support
            if (imageContainer) {
                imageContainer.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        startDrag(touch.clientX, touch.clientY);
                    }
                });
                
                imageContainer.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        updateDrag(touch.clientX, touch.clientY);
                    }
                });
                
                imageContainer.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    endDrag();
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                switch(e.key) {
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomToCenter(1.3);
                        break;
                    case '-':
                        e.preventDefault();
                        zoomToCenter(0.77);
                        break;
                    case '0':
                        e.preventDefault();
                        currentZoom = 1;
                        centerImage();
                        updateZoomLevel();
                        break;
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        currentZoom = 1.04;
                        centerImage();
                        updateZoomLevel();
                        break;
                    case 'g':
                    case 'G':
                        e.preventDefault();
                        toggleGridBtn.click();
                        break;
                }
            });

            // Enhanced field validation status indicators
            function updateFieldStatus() {
                // Get all form fields (inputs and textareas)
                const allFields = document.querySelectorAll('input, textarea');
                
                allFields.forEach(field => {
                    // Skip disabled and readonly fields
                    if (field.disabled || field.readOnly) return;
                    
                    const container = field.closest('.field-container');
                    if (!container) return;
                    
                    const checkIcon = container.querySelector('.fa-check');
                    const warningIcon = container.querySelector('.fa-exclamation-triangle');
                    const isRequired = field.hasAttribute('data-required');
                    
                    // Check if field has a meaningful value (not just placeholder text)
                    const fieldValue = field.value ? field.value.trim() : '';
                    const placeholderValues = ['none', 'null', 'n/a', 'na', '', 'undefined', 'nil'];
                    const hasRealValue = fieldValue !== '' && !placeholderValues.includes(fieldValue.toLowerCase());
                    
                    if (hasRealValue) {
                        // Field has real value - show as complete (green)
                        field.classList.remove('field-incomplete', 'field-error');
                        field.classList.add('field-complete');
                        if (checkIcon) {
                            checkIcon.classList.remove('hidden');
                        }
                        if (warningIcon) {
                            warningIcon.classList.add('hidden');
                        }
                    } else if (isRequired) {
                        // Required field with no real value - show as incomplete (red)
                        field.classList.remove('field-complete', 'field-error');
                        field.classList.add('field-incomplete');
                        if (checkIcon) {
                            checkIcon.classList.add('hidden');
                        }
                        if (warningIcon) {
                            warningIcon.classList.remove('hidden');
                        }
                    } else {
                        // Optional field with no real value - neutral state
                        field.classList.remove('field-complete', 'field-incomplete', 'field-error');
                        if (checkIcon) {
                            checkIcon.classList.add('hidden');
                        }
                        if (warningIcon) {
                            warningIcon.classList.add('hidden');
                        }
                    }
                });
            }

        document.getElementById('quickApprove')?.addEventListener('click', async function() {
            // SAFETY CHECK: Don't proceed if button is disabled
            if (this.disabled) {
                showNotification('Cannot approve: Please fill in all required Salesforce fields (Matter Name, Matter ID, Claimant)', 'warning');
                return;
            }
            
            const formData = new FormData(document.getElementById('checkDetailsForm'));
            const checkId = '{{ check.id }}';
            
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Approving...';
                
                const response = await fetch(`/api/checks/approve/${checkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showApprovedBanner(result.validated_at, result.validated_by_name);
                    showNotification('Check approved! Salesforce protocol initiated.', 'success');
                    disableFormEditing();
                } else {
                    showNotification(result.message || 'Failed to approve check', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="fa-solid fa-check w-4 h-4"></i> Quick Approve';
                }
            } catch (error) {
                console.error('Error approving check:', error);
                showNotification('Error approving check', 'error');
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-check w-4 h-4"></i> Quick Approve';
            }
        });

        document.getElementById('sendToReview')?.addEventListener('click', async function() {
            if (!confirm('Send this check for manual review?')) {
                return;
            }
            
            const formData = new FormData(document.getElementById('checkDetailsForm'));
            const checkId = '{{ check.id }}';
            
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Updating...';
                
                const response = await fetch(`/api/checks/needs-review/${checkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('Check status changed to needs review!', 'warning');
                    updateStatusDisplay('needs_review');
                    disableNeedsReviewButton();
                } else {
                    showNotification(result.message || 'Failed to update check status', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="fa-solid fa-magnifying-glass w-4 h-4"></i> Needs Review';
                }
            } catch (error) {
                console.error('Error updating check status:', error);
                showNotification('Error updating check status', 'error');
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-magnifying-glass w-4 h-4"></i> Needs Review';
            }
        });

        document.getElementById('saveProgress')?.addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('checkDetailsForm'));
            const checkId = '{{ check.id }}';
            
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                this.disabled = true;
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin w-4 h-4 mr-2"></i>Saving...';
                
                const response = await fetch(`/api/checks/save/${checkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('Changes saved successfully!', 'success');
                    updateLastSaved(result.updated_at);
                } else {
                    showNotification(result.message || 'Failed to save changes', 'error');
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                showNotification('Error saving changes', 'error');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-save w-4 h-4"></i> Save Progress';
            }
        });

        function showApprovedBanner(validatedAt, validatedByName) {
            // Remove any existing banner
            const existingBanner = document.getElementById('validationBanner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            const main = document.querySelector('main');
            const banner = document.createElement('div');
            banner.id = 'validationBanner';
            banner.className = 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-r-lg shadow-md';
            banner.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fa-solid fa-check-circle w-5 h-5 mr-3"></i>
                        <div>
                            <strong>‚úì Check Approved!</strong> Salesforce protocol has been initiated.
                            <div class="text-sm mt-1">Validated at ${new Date(validatedAt).toLocaleString()} by ${validatedByName}</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-green-600 hover:text-green-800 transition-colors">
                        <i class="fa-solid fa-times w-4 h-4"></i>
                    </button>
                </div>
            `;
            main.insertBefore(banner, main.firstChild);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showNeedsReviewBanner(flaggedAt, flaggedByName) {
            // Remove any existing banner
            const existingBanner = document.getElementById('validationBanner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            const main = document.querySelector('main');
            const banner = document.createElement('div');
            banner.id = 'validationBanner';
            banner.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-r-lg shadow-md';
            banner.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fa-solid fa-exclamation-triangle w-5 h-5 mr-3"></i>
                        <div>
                            <strong>‚ö† Check Flagged for Review!</strong> This check requires manual verification.
                            <div class="text-sm mt-1">Flagged at ${new Date(flaggedAt).toLocaleString()} by ${flaggedByName}</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-yellow-600 hover:text-yellow-800 transition-colors">
                        <i class="fa-solid fa-times w-4 h-4"></i>
                    </button>
                </div>
            `;
            main.insertBefore(banner, main.firstChild);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function disableFormEditing() {
            document.querySelectorAll('#checkDetailsForm input, #checkDetailsForm textarea').forEach(field => {
                field.disabled = true;
                field.classList.add('bg-gray-100', 'text-gray-600');
            });
            
            // Disable all action buttons (with null checks)
            const saveBtn = document.getElementById('saveProgress');
            const approveBtn = document.getElementById('quickApprove');
            const reviewBtn = document.getElementById('sendToReview');
            
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.classList.remove('bg-slate-500', 'hover:bg-slate-400');
                saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
            
            if (approveBtn) {
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<i class="fa-solid fa-check w-4 h-4"></i> Approved';
                approveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                approveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
            
            if (reviewBtn) {
                reviewBtn.disabled = true;
                reviewBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                reviewBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function disableNeedsReviewButton() {
            const needsReviewBtn = document.getElementById('sendToReview');
            if (needsReviewBtn) {
                needsReviewBtn.disabled = true;
                needsReviewBtn.innerHTML = '<i class="fa-solid fa-exclamation-triangle w-4 h-4"></i> Flagged for Review';
                needsReviewBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                needsReviewBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function updateStatusDisplay(newStatus) {
            // Find the status badge and update it
            const statusBadge = document.querySelector('.surface .px-3.py-1.rounded-full');
            if (statusBadge) {
                // Remove old classes
                statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-gray-100', 'text-gray-800', 'bg-orange-100', 'text-orange-800');
                
                // Add new classes based on status
                if (newStatus === 'needs_review') {
                    statusBadge.classList.add('bg-orange-100', 'text-orange-800');
                    statusBadge.textContent = 'Needs Review';
                } else if (newStatus === 'approved') {
                    statusBadge.classList.add('bg-green-100', 'text-green-800');
                    statusBadge.textContent = 'Approved';
                } else if (newStatus === 'pending') {
                    statusBadge.classList.add('bg-yellow-100', 'text-yellow-800');
                    statusBadge.textContent = 'Pending';
                } else {
                    statusBadge.classList.add('bg-gray-100', 'text-gray-800');
                    statusBadge.textContent = newStatus.replace('_', ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                }
            }
        }

        function updateLastSaved(timestamp) {
            let lastSavedEl = document.getElementById('lastSaved');
            if (!lastSavedEl) {
                lastSavedEl = document.createElement('div');
                lastSavedEl.id = 'lastSaved';
                lastSavedEl.className = 'text-xs text-gray-500 mt-2';
                document.querySelector('.surface').appendChild(lastSavedEl);
            }
            lastSavedEl.innerHTML = `<i class="fa-solid fa-clock mr-1"></i>Last saved: ${new Date(timestamp).toLocaleTimeString()}`;
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium shadow-lg transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
            }`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fa-solid fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info'} w-4 h-4 mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        });
    </script>
</body>
</html>